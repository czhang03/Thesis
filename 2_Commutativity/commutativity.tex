\chapter{Kleene Algebra with Atomic Commutativity}
\label{chapter:body}
\thispagestyle{myheadings}

% set this to the location of the figures for this chapter. it may
% also want to be ../Figures/2_Body/ or something. make sure that
% it has a trailing directory separator (i.e., '/')!
\graphicspath{{2_Commutativity/Figures/}}

\section{Free KA with Atomic Commutativity}

It is common to extend Kleene Algebra with additional equations 
to enrich the theory\cite{DBLP:conf/fossacs/DoumaneKPP19, Kozen_Mamouras_2014, Pous_Rot_Wagemaker_2022}.
In this paper we will consider atomic commutativity hypotheses,
where the equations in the hypotheses are of the form \(p q = q p\)
with \(p\) and \(q\) being primitives.

A \emph{commutable set} \((X, ‚àº)\) is a set with a reflexive symmetric relation \(‚àº: X √ó X\)
called \emph{commuting relation},
we typically omit \(‚àº\) and just denote the commutable set as \(X\).
In this paper we only consider finite commutable sets.

We say a commutable set \(X\) is \emph{discrete} if the relation \(‚àº\) is the identity relation.
A homomorphism \(h: X ‚Üí Y\) between two commutable set \(X\) and \(Y\)
is a function that preserves the commuting relation:
\[x‚ÇÅ ‚àº x‚ÇÇ ‚üπ h(x‚ÇÅ) ‚àº h(x‚ÇÇ).\]
The carrier of a commutable set \(X\) can be considered as a discrete commutable set,
and we denote this discrete commutable set as \(X_‚âÅ\).
There is a canonical homomorphism:
\begin{align*}
  [-]_‚àº & : X_‚âÅ ‚Üí X \\  
  [x]_‚àº & ‚âú x.
\end{align*}

We can construct the free KA a commutable set \(X\) by 
taking all the KA terms over \(X\) modulo the equalities provable from KA axioms plus
the following equations \(\{p q = q p ‚à£ p ‚àº q\}\).
Intuitively, the commuting relation of \(X\) specifies 
the atomic commutativity hypotheses in \(\KA(X)\).
Since the free KA over a set is just a free KA over discrete commutable set,
we abuse the notation to denote the free KA over a commutable set \(X\) as \(\KA(X)\).

Notice all Kleene Algebra form a commutable set, 
with the commuting relation defined as follows:
\[e‚ÇÅ ‚àº e‚ÇÇ ‚ü∫ e‚ÇÅ ‚ãÖ e‚ÇÇ = e‚ÇÇ ‚ãÖ e‚ÇÅ.\]
We can show that the free KA over commutable set enjoys 
similar universal property as free KA over set.
We first prove the universal property without the uniqueness requirement:

\begin{theorem}\label{the: existence of KA with commutable set lifting}
  For all commutable set \(X\), a KA \(ùí¶\), and a commutable set homomorphism \(IÃÇ: X ‚Üí ùí¶\),
  then there is a KA interpretation \(I: \KA(X) ‚Üí ùí¶\), s.t. the following diagram commutes:
  \[\begin{tikzcd}
    \KA(X) \ar[dashed]{r}{I} & ùí¶ \\ 
    X \ar[swap]{ur}{IÃÇ} \ar[hookrightarrow]{u}{i}
  \end{tikzcd}\]
\end{theorem}
\begin{proof}
  Given the function \(IÃÇ\), 
  we can apply the standard technique to generate the homomorphism \(I\) 
  by induction on the input:
  \begin{align*}
    I(a) & ‚âú IÃÇ(a) & a ‚àà X \\  
    I(1) & ‚âú 1_ùí¶ \\  
    I(0) & ‚âú 0_ùí¶ \\  
    I(e‚ÇÅ + e‚ÇÇ) & ‚âú I(e‚ÇÅ) + I(e‚ÇÇ) \\
    I(e‚ÇÅ ‚ãÖ e‚ÇÇ) & ‚âú I(e‚ÇÅ) ‚ãÖ I(e‚ÇÇ) \\
    I(e^*) & ‚âú I(e)^*
  \end{align*}
  such a homomorphism exists, and makes the diagram commute:
  \[I(a) = IÃÇ(a), ‚àÄ a ‚àà X.\]
\end{proof}

To prove uniqueness, we will prove a stronger theorem first.
\begin{theorem}\label{the: ordered of homomorphism is determined by order on the primitives}
  Given two interpretation \(I, I': \KA(X) ‚Üí ùí¶\),
  \[I(e) ‚â• I'(e) ‚ü∫ ‚àÄ a ‚àà X, I(a) ‚â• I'(a),\]
  this result implies \(I(e) = I'(e) ‚ü∫ ‚àÄ a ‚àà X, I(a) = I'(a).\)
\end{theorem}

\begin{proof}
  By induction on the structure of \(e\), and all KA operations preserve order.
  We show the star case as example: assume \(I(e) ‚â• I'(e)\),
  we need to show \(I(e^*) ‚â• I'(e^*)\).
  Since \(I\) is a homomorphism, and star preserves order:
  \[I(e^*) = (I(e))^* ‚â• (I'(e))^* = I'(e^*).\]
\end{proof}

\begin{corollary}[Universal Property]
  For all commutable set \(X\), a KA \(ùí¶\), and a commutable set homomorphism \(IÃÇ: X ‚Üí ùí¶\),
  then there is a unique KA interpretation \(I: \KA(X) ‚Üí ùí¶\), s.t. the following diagram commutes:
  \[\begin{tikzcd}
    \KA(X) \ar[dashed]{r}{I} & ùí¶ \\ 
    X \ar[swap]{ur}{IÃÇ} \ar[hookrightarrow]{u}{i}
  \end{tikzcd}\]
\end{corollary}

\begin{proof}
  By \Cref{the: existence of KA with commutable set lifting}, \(I\) exists. 
  By \Cref{the: ordered of homomorphism is determined by order on the primitives},
  if there exists another interpretation \(I'\) that makes the diagram commute,
  then \[I(a) = I'(a), ‚àÄ a ‚àà X ‚üπ I(e) = I'(e).\]
\end{proof}
As usual, we will use the notation \(I\) for both \(I\) and \(IÃÇ\).

The words over a commutable set \(X\) are monoid terms modulo
monoid equations plus the commutativity axioms \(\{a b = b a ‚à£ a ‚àº b\}\).
We still use \(œµ\) as the identity of the monoid and call it the empty word;  
and we use the same notation \(\Word(X)\) for all the words over \(X\).
The language model over a commutable set \(X\) is the powerset of 
all words over \(X\), with operation defined by Kozen~\cite{DBLP:conf/lics/Kozen97},
denoted as \(‚Ñí_X\).
The language interpretation is generated by the same action on primitives
as in Kleene Algebra:
\begin{align*}
  L & : X ‚Üí ‚Ñí_X \\
  L & (a) = \{a\}
\end{align*}


\paragraph*{Notation}
In the rest of the article, notations \(\KA(X)\), \(\Word(X)\), and \(‚Ñí_X\)
always refers to the commutative variant, where \(X\) is a commutable set.
When we are referring to the non-commutative KA (word, language model, etc.), 
we will consider them as the KA (word, language model, etc.) over a discrete commutable set.
As we have mentioned before, \(2 ‚âú \{0, 1\}\)
denotes the unique KA that only contains two distinct identities;  
this KA is also the free KA generated by the empty set \(\KA(‚àÖ)\).
Finally, when given a finite set of terms \(S ‚äÜ \KA(X)\), 
we will sometimes use \(S\) to denote 
the sum of all its elements \((‚àë_{e ‚àà S} e) ‚àà \KA(e)\).


\section{Word Inhabitant Problem}

Given a commutable set,
we allow a word in \(‚Ñí_X\) to be implicitly coerced into \(\KA(X)\),
where we pick the multiplication operator in \(\KA(X)\) as the monoidal multiplication.

Then given a word \(w ‚àà ‚Ñí_X\) and a KA expression \(e ‚àà \KA(X)\),
the word inhabitant problem is the following inequality: \[w ‚â§ e.\]
The problem is complete with language interpretation when:
\[w ‚àà L(e) ‚ü∫ w ‚â§ e.\] 
We will show that the word inhabitance problem is complete and decidable
in Kleene Algebra with atomic commutativity hypotheses.

The core technique of this section is to construct 
a sound empty word predicate \(E: \KA(X) ‚Üí 2\) 
and derivative operation \(Œ¥‚Çê: \KA(X) ‚Üí \KA(X)\).

\subsection{Empty Word Predicate}

In this section we will prove a stronger result than 
the soundness of empty word predicate:
\[‚àÄ e ‚àà \KA(X), e = E(e) + e',\]
where \(E: \KA(X) ‚Üí 2\) is the empty word predicate 
on the free KA over any commutable set \(X\), and \(œµ ‚àâ L(e')\). 
This result is obtained by decomposing using the following matrix model.

\begin{theorem}
  For any Kleene Algebra \(ùí¶\), 
  matrix of the following shapes forms a Kleene Algebra:
  \[D_E(ùí¶) ‚âú \{\begin{bmatrix}
    p & q \\
    0 & p + q
  \end{bmatrix} ‚à£ p, q ‚àà ùí¶\}.\]
\end{theorem}

\begin{proof}
  We will only need to show that matrix of this shape is closed under all the KA operations.

  The identities and addition are easy to verify. 
  So we will only focus on verifying the closure under multiplication and star operation.

  The multiplication case:
  \[
    \begin{bmatrix}
      p‚ÇÅ & q‚ÇÅ \\
      0 & p‚ÇÅ + q‚ÇÅ
    \end{bmatrix} 
    \begin{bmatrix}
      p‚ÇÇ & q‚ÇÇ \\
      0 & p‚ÇÇ + q‚ÇÇ
    \end{bmatrix} = 
    \begin{bmatrix}
      p‚ÇÅ p‚ÇÇ & p‚ÇÅ q‚ÇÇ + q‚ÇÅ (p‚ÇÇ + q‚ÇÇ) \\
      0 & (p‚ÇÅ + q‚ÇÅ) (p‚ÇÇ + q‚ÇÇ)
    \end{bmatrix}.
  \]
  Since \(p‚ÇÅp‚ÇÇ + p‚ÇÅ q‚ÇÇ + q‚ÇÅ (p‚ÇÇ + q‚ÇÇ) = (p‚ÇÅ + q‚ÇÅ) (p‚ÇÇ + q‚ÇÇ)\),
  these matrices are closed under multiplication.

  The star case:
  \[
    \begin{bmatrix}
      p & q \\
      0 & p + q
    \end{bmatrix}^* = 
    \begin{bmatrix}
      p^* & p^* q (p + q)^* \\
      0 & (p + q)^*
    \end{bmatrix}.
  \]
  With a standard theorem of KA \((p + q)^* = p^*(q p^*)^*\),
  we are able to derive the closure under star operation:
  \begin{align*}
    p^* + p^* q (p + q)^* 
      & = p^* + p^* q p^* (q p^*)^* \\ 
      & = p^* (1 + q p^* (q p^*)^*) \\  
      & = p^* (q p^*)^* = (p + q)^*
  \end{align*}
\end{proof}

Given any commutable set \(X\), consider the following matrix: 
\[D_E(\KA(X)) ‚àã u_E ‚âú \begin{bmatrix}
  1 & X X^* \\  
  0 & X^*
\end{bmatrix},\]
where \(X\) is a shorthand for the expression \((‚àë_{x ‚àà X} x)\).
By simply unfolding the definition, we can verify that \(u_E ‚ãÖ u_E = u_E\)
and \(u_E ‚â• 1\).
Therefore, all the matrices less than \(u_E\) in \(D_E(\KA(X))\) forms a Kleene Algebra.
We denote this Kleene Algebra as \(D_E(\KA(X))_{u_E}\).

In order to decompose an arbitrary expression,
we will define an interpretation into \(D_E(\KA(X))_{u_E}\) 
by lifting the following actions
\begin{align*}
  I_E & : \KA(X) ‚Üí D_E(\KA(X))_{u_E} \\
  I_E & (a) ‚âú 
  \begin{bmatrix}
    0 & a \\  
    0 & a
  \end{bmatrix}.
\end{align*}
Because the projection \(œÄ_{2,2}\) is a homomorphism,
then \(œÄ_{2,2} ‚àò I_E\) is an interpretation.
Recall that interpretation is uniquely determined by the action on the primitives,
and \[œÄ_{2,2} ‚àò I_E(a) = a, ‚àÄ a ‚àà X.\]
Therefore, for all term in \(e ‚àà \KA(X)\),
the \(2,2\) component of \(I_E(e)\) is exactly \(e\) itself:
\[œÄ_{2,2} ‚àò I_E(e) = e.\]

Then we define the empty word predicate as follows:
\[E(e) ‚âú œÄ_{1,1}(I_E(e)), \quad e' ‚âú œÄ_{1,2}(I_E(e)).\]
By \Cref{the: diagonal image of free model is closed under sub KA},
and \(œÄ_{1,1}(I_E(a)) = 0 ‚àà 2\) for all primitives \(a\),
\[‚àÄe ‚àà \KA(X), E(e) = œÄ_{1,1}(I_E(e)) ‚àà 2 ‚äÜ \KA(X).\]
Therefore, we can treat \(E\) as a homomorphism of the type \(\KA(X) ‚Üí 2\).

\begin{corollary}[empty word decomposition]\label{the: empty word decomposition}
  All expression \(e ‚àà \KA(X)\) over a commutable set \(X\)
  can be decomposed in the following way:
  \[e = E(e) + e' \text{ where } œµ ‚àâ L(e').\]
\end{corollary}

\begin{proof}
  Recall that 
  \[\begin{bmatrix}
    E(e) & e' \\  
    0 & e 
  \end{bmatrix} ‚âú I_E(e).\]
  Since  \(I_E(e) ‚àà D_E(\KA(X))\), we have 
  \[e = E(e) + e'.\]

  Furthermore, since elements in \(D_E(\KA(X))_{u_E}\) is bounded by \(u_E\),
  \[e' = œÄ_{2,2}(I_E(e)) ‚â§ X X^*.\]
  Because \(œµ ‚àâ L(X X^*)\), and \(l\) is a homomorphism,
  we conclude \(œµ ‚àâ L(e) ‚äÜ L(X X^*)\).
\end{proof}

\begin{corollary}[Soundness Of Empty Word Property]
  Let \(E: ‚Ñí_X ‚Üí 2\) the empty word predicate on the language over a commutable set
  \(E(l) = œµ ‚àà l,\) then the following diagram commute
  \[\begin{tikzcd}
    \KA(K) \ar{r}{E} \ar{d}{l} & 2 \\  
    ‚Ñí_K \ar[swap]{ur}{E}
  \end{tikzcd}\]
\end{corollary}

\begin{proof}
  We only need to prove that for all \(e ‚àà \KA(X)\), 
  \[E(e) = 1 ‚ü∫ œµ ‚àà l.\]
  We show this by case analysis on \(E(e)\):
  \begin{itemize}
    \item If \(E(e) = 1\), then 
      \[L(e) = L(E(e)) ‚à™ L(e') = \{œµ\} ‚à™ L(e') ‚àã œµ.\]
    \item If \(E(e) = 0\), recall that \(œµ ‚àâ L(e')\),
      \[L(e) = L(E(e)) ‚à™ L(e') = L(e') ‚àå œµ.\]
  \end{itemize}
\end{proof}

\subsection{Derivative}

Similar to the last section, 
the derivative operation will also be defined by a decomposition:
for all \(e ‚àà \KA(X)\) and \(a ‚àà X\),
\[e = a ‚ãÖ Œ¥‚Çê(e) + œÅ‚Çê(e),\]
where the language interpretation for \(a ‚ãÖ Œ¥‚Çê(e)\) and \(œÅ‚Çê(e)\) are disjoint.
This result will imply the soundness of derivative.

\begin{theorem}
  Given a KA \(ùí¶\) and an element \(t ‚àà ùí¶\),
  the following matrices form a KA:
  \[D‚Çú(ùí¶) = \{\begin{bmatrix}
    a & b & c \\
    0 & d & 0 \\  
    0 & 0 & d
  \end{bmatrix} ‚à£ d = a + b + t c, a t = t a\}\]
\end{theorem}

\begin{proof}
  We need to show that these matrices are closed under KA operations.
  The closure under identities and addition are trivial, 
  we only show the multiplication case and the star case.

  The multiplication case:
  \begin{align*}
    & \begin{bmatrix}
      p‚ÇÅ & q‚ÇÅ & r‚ÇÅ \\
      0 & s‚ÇÅ & 0 \\  
      0 & 0 & s‚ÇÅ
    \end{bmatrix}
    \begin{bmatrix}
      p‚ÇÇ & q‚ÇÇ & r‚ÇÇ \\
      0 & s‚ÇÇ & 0 \\  
      0 & 0 & s‚ÇÇ
    \end{bmatrix} \\
    ={} & \begin{bmatrix}
      p‚ÇÅ p‚ÇÇ & p‚ÇÅq‚ÇÇ + q‚ÇÅs‚ÇÇ & p‚ÇÅ r‚ÇÇ + r‚ÇÅ s‚ÇÇ \\
      0 & s‚ÇÅ s‚ÇÇ & 0 \\  
      0 & 0 & s‚ÇÅ s‚ÇÇ
    \end{bmatrix}
  \end{align*}
  We verify that the equation is preserved:
  \begin{align*}
    s‚ÇÅ s‚ÇÇ & = (p‚ÇÅ + q‚ÇÅ + p r‚ÇÅ) ‚ãÖ s‚ÇÇ \\  
    & = p‚ÇÅ s‚ÇÇ + q‚ÇÅ s‚ÇÇ + p r‚ÇÅ s‚ÇÇ \\  
    & = p‚ÇÅ (p‚ÇÇ + q‚ÇÇ + p r‚ÇÇ) + q‚ÇÅ s‚ÇÇ + p r‚ÇÅ s‚ÇÇ \\  
    & = p‚ÇÅ p‚ÇÇ + (p‚ÇÅq‚ÇÇ + q‚ÇÅs‚ÇÇ) + p‚ÇÅ p r‚ÇÇ + p r‚ÇÅ s‚ÇÇ \\ 
    & = p‚ÇÅ p‚ÇÇ + (p‚ÇÅq‚ÇÇ + q‚ÇÅs‚ÇÇ) + p(p‚ÇÅ r‚ÇÇ + r‚ÇÅ s‚ÇÇ) 
  \end{align*}
  The last step uses the commutativity of \(t\) and \(p‚ÇÅ\).
  Then we verify the commutativity condition:
  \[(p‚ÇÅ p‚ÇÇ) t = p‚ÇÅ t p‚ÇÇ = t (p‚ÇÅ p‚ÇÇ).\]
  Hence, \(D‚Çú(ùí¶)\) is closed under multiplication.

  The star case:
  \[
    \begin{bmatrix}
      p & q & r \\
      0 & s & 0 \\  
      0 & 0 & s
    \end{bmatrix}^*
    = 
    \begin{bmatrix}
      p^*  & p^*  q s^* & p^*  r s^* \\
      0 & s^* & 0 \\  
      0 & 0 & s^*
    \end{bmatrix}
  \]
  the equation is preserved:
  \begin{align*}
    s^* & = (p + q + t c)^* \\  
    & = p^* ((q + pc) p^*)^*\\
    & = p^* (1 + (q + pc) p^* ((q + pc) p^* )^*) \\
    & = p^* (1 + (q + pc) s^*) \\ 
    & = p^* + p^* q s^* + p^* t r s^* \\
    & = p^* + p^* q s^* + t p^* r s^*
  \end{align*}
  The last line is by standard KA theorem:
  \[p t = t p ‚üπ p^*  t = t p^* .\]
  The commutativity condition \(p^*  t = t p^*\) is also implied by the above theorem.
  Therefore, \(D‚Çú(ùí¶)\) is closes under star operations.
\end{proof}

Given a commutable set \(X\), and an element \(a ‚àà X\),
we can partition the rest of the elements in \(X\)
by whether they commute with \(a\):
\[X_{‚àº a} ‚âú \{b ‚à£ b ‚àº a, b ‚â† a\}, \quad X_{‚âÅ a} = \{b ‚à£ b ‚âÅ a\}.\]
Since \(a\) commutes with every element of \(X_{‚àº a}\), 
\(a\) commutes with \(X_{‚àº a}\): \(X_{‚àº a} ‚ãÖ a = a ‚ãÖ X_{‚àº a}\),
then by standard theorem of KA: \[X_{‚àº a}^* ‚ãÖ a = a ‚ãÖ X_{‚àº a}^*.\]

Consider the following matrix:
\[D‚Çê(\KA(X)) ‚àã u‚Çê = 
\begin{bmatrix}
  X_{‚àº a}^* & X_{‚àº a}^* X_{‚âÅ a} X^* & X^* \\  
  0 & X^* & 0 \\  
  0 & 0 & X^*
\end{bmatrix}.\]
It is easy to verify that \(u‚Çê ‚â• 1\) and \(u‚Çê ‚ãÖ u‚Çê ‚â§ u‚Çê\).
Therefore, the elements under \(u‚Çê\) forms a KA: \(D‚Çê(\KA(X))_{u‚Çê}\).
The purpose of model \(D‚Çê(\KA(X))_{u‚Çê}\) is clear when we look at the 
language interpretation for each of the component,
let \[\begin{bmatrix}
  p & q & r \\  
  0 & s & 0 \\  
  0 & 0 & s 
\end{bmatrix} ‚àà D‚Çê(\KA(X))_{u‚Çê}\]
then 
\begin{itemize}
  \item \(L(p) ‚â§ L(X_{‚àºa}^*)\) contains only words with symbols that commutes with primitive \(a\),
    but is not \(a\).
  \item \(L(q) ‚â§ L(X_{‚àºa}^* X_{‚âÅa} X^*)\) contains words that starts with 
    arbitrary number of primitives that commutes with \(a\), 
    then a primitive that does not commute with \(a\), followed by arbitrary primitives.
\end{itemize}
Both \(L(p)\) and \(L(q)\) do not contain words of the form \(a ‚ãÖ w\) 
for any word \(w ‚àà \Word(X)\); by the property of \(D‚Çê(\KA(X))\):
\[L(s) = L(p) + L(q) + a ‚ãÖ L(r).\]
Thus, \(L(r)\) will be the language derivative of \(L(s)\) with respect to primitive \(a\), 

To apply this decomposition on an arbitrary expression, we define an
interpretation by lifting the following action on primitives:
\begin{align*}
  I_a & : X ‚Üí D‚Çê(\KA(X))_{u‚Çê} \\
  I_a & (b) ‚âú \begin{cases}
    \begin{bmatrix}
      b & 0 & 0 \\
      0 & b & 0 \\
      0 & 0 & b 
    \end{bmatrix} & b ‚àà X_{‚àº a} \\  
    \begin{bmatrix}
      0 & b & 0 \\
      0 & b & 0 \\
      0 & 0 & b 
    \end{bmatrix} & b ‚àà X_{‚âÅ a} \\
    \begin{bmatrix}
      0 & 0 & 1 \\
      0 & b & 0 \\
      0 & 0 & b 
    \end{bmatrix} & b = a 
  \end{cases}
\end{align*}

Again, since \(œÄ_{3,3}\) and \(œÄ_{2,2}\) are homomorphisms, 
\(œÄ_{3,3} ‚àò I_a\) and \(œÄ_{2,2} ‚àò I_a\) are interpretations.
Because interpretations are uniquely determined by the action on the primitives, 
and 
\[‚àÄ b ‚àà X, œÄ_{3,3} ‚àò I_a(b) = œÄ_{2,2} ‚àò I_a(b) = b,\]
then \(œÄ_{3,3} ‚àò I_a\) and \(œÄ_{2,2} ‚àò I_a\) are both identity homomorphisms.
This means the \(2,2\) and \(3,3\) component of \(I_a(e)\) are exactly \(e\) 
for all \(e ‚àà \KA(X)\). Let 
\[\begin{bmatrix}
  p & q & r \\  
  0 & e & 0 \\  
  0 & 0 & e 
\end{bmatrix} ‚âú I‚Çê(e) ‚àà D‚Çê(\KA(X))_{u‚Çê}.\]
We can define the derivative \(Œ¥‚Çê\) and residual \(œÅ‚Çê\) as follows:
\[Œ¥‚Çê(e) ‚âú r, \quad œÅ‚Çê(e) ‚âú p + q.\]
Then the following corollary can be derived simply from 
the definition of \(D‚Çê(\KA(X))_{u‚Çê}\).

\begin{corollary}[decomposition]\label{the: decomposition of derivative and residual}
  For all expressions \(e ‚àà \KA(X)\), primitives \(a ‚àà X\),
  and word \(w ‚àà ‚Ñí_X\),
  \[e = œÅ‚Çê(e) + a ‚ãÖ Œ¥‚Çê(e) \text{ and } a ‚ãÖ w ‚àâ L(œÅ‚Çê(e)).\]
\end{corollary}

\begin{theorem}[Soundness Property]
  For a primitive \(a\) in a commutable set \(X\),
  let the derivative on language \(Œ¥‚Çê\) defined as \(Œ¥‚Çê(l) ‚âú \{s ‚à£ a ‚ãÖ w ‚àà l\}\),
  the following diagram commute:
  \[\begin{tikzcd}
    \KA(X) \ar{r}{Œ¥‚Çê} \ar{d}{L} & \KA(X) \ar{d}{L} \\  
    ‚Ñí_X \ar{r}{Œ¥‚Çê} & ‚Ñí_X 
  \end{tikzcd}\]
\end{theorem}

\begin{proof}
  Given any word \(w ‚àà ‚Ñí_X\) and in \(e ‚àà \KA(X)\):
  \begin{align*}
    & s ‚àà Œ¥‚Çê(L(e)) \\  
    & ‚ü∫ a ‚ãÖ w ‚àà L(e) & \text{by definition of language \(Œ¥‚Çê\)}\\  
    & ‚ü∫ a ‚ãÖ w ‚àà L(œÅ‚Çê(e) + a ‚ãÖ Œ¥‚Çê(e)) & \text{\Cref{the: decomposition of derivative and residual}} \\  
    & ‚ü∫ a ‚ãÖ w ‚àà L(a ‚ãÖ Œ¥‚Çê(e)) & \text{\(a ‚ãÖ w ‚àâ L(œÅ‚Çê(e))\)}\\  
    & ‚ü∫ s ‚àà L(Œ¥‚Çê(e)).
  \end{align*}
  Thus, for all \(e ‚àà \KA(X)\), \(Œ¥‚Çê(L(e)) = L(Œ¥‚Çê(e))\), we have reached our conclusion.
\end{proof}

Finally, we prove a Galois connection that the derivative is expected to satisfy.

\begin{lemma}[Basic Algebraic Properties]
  Following basic algebraic properties are true,
  for all primitive \(a\) and expressions \(e, e'\):
  \begin{align*}
    Œ¥‚Çê(a e) & = e \\
    œÅ‚Çê(a e) & = 0 \\  
    Œ¥‚Çê(œÅ‚Çê(e)) & = 0 \\
    e ‚â• e' & ‚üπ Œ¥‚Çê(e) ‚â• Œ¥‚Çê(e') \\  
    e ‚â• e' & ‚üπ œÅ‚Çê(e) ‚â• œÅ‚Çê(e') 
  \end{align*}
\end{lemma}

\begin{proof}
  We first compute \(I‚Çê(a e)\):
  \[I‚Çê(a e) = I‚Çê(a) ‚ãÖ I‚Çê(e) = 
  \begin{bmatrix}
    0 & 0 & 1 \\  
    0 & a & 0 \\  
    0 & 0 & a 
  \end{bmatrix}
  \begin{bmatrix}
    p & q & r \\  
    0 & e & 0 \\  
    0 & 0 & e 
  \end{bmatrix},
  \]
  for some expressions \(p, q, r ‚àà \KA(X)\).
  Then 
  \[I‚Çê(a e) = 
  \begin{bmatrix}
    0 & 0 & 1 \\  
    0 & a & 0 \\  
    0 & 0 & a 
  \end{bmatrix}
  \begin{bmatrix}
    p & q & r \\  
    0 & e & 0 \\  
    0 & 0 & e 
  \end{bmatrix}
  = \begin{bmatrix}
    0 & 0 & e \\  
    0 & a e & 0 \\
    0 & 0 & ae
  \end{bmatrix}.\]
  Therefore, we obtain the conclusion \(Œ¥‚Çê(a e) = e\) and \(œÅ‚Çê(a e) = 0\).

  Notice that \(œÅ(e) ‚â§ X_{‚àº a}^* + X_{‚àº a}^* X_{‚âÅ a} X^*\),
  therefore 
  \begin{align*}
    I‚Çê(œÅ(e)) & ‚â§ I‚Çê(X_{‚àº a}^* + X_{‚àº a}^* X_{‚âÅ a} X^*)\\ 
    & = \begin{bmatrix}
      X_{‚àº a}^* & X_{‚àº a}^* X_{‚âÅ a} X^* & 0 \\  
      0 & X_{‚àº a}^* + X_{‚àº a}^* X_{‚âÅ a} X^* & 0 \\
      0 & 0 & X_{‚àº a}^* + X_{‚àº a}^* X_{‚âÅ a} X^*
    \end{bmatrix}
  \end{align*}
  Therefore \(I‚Çê(œÅ(e)) ‚â§ 0\), and since \(0\) is the smallest element,
  We obtain the conclusion \(I‚Çê(œÅ(e)) = 0\).

  The monotonicity can be derived from the monotonicity of \(I‚Çê\).
  When \(e ‚â• e'\), we have \(I‚Çê(e) ‚â• I‚Çê(e')\). 
  Recall that the ordering on matrices are component order,
  since \(Œ¥‚Çê(e)\) and \(œÅ‚Çê(e)\) are 
  either component of \(I‚Çê(e)\) or the sum of components of \(I‚Çê(e)\),
  therefore \(Œ¥‚Çê(e) ‚â• Œ¥‚Çê(e')\) and \(œÅ‚Çê(e) ‚â• œÅ‚Çê(e')\).
\end{proof}

\begin{theorem}[Galois Connection]\label{the: Galois connection for derivative}
  Given a commutative set \(X\), for all expression \(e, e' ‚àà \KA(X)\) and primitive \(a ‚àà X\),
  \[a e ‚â§ e' ‚ü∫ e ‚â§ Œ¥‚Çê(e').\]
\end{theorem}

\begin{proof}
  We first show \(a e ‚â§ e' ‚ü∫ e ‚â§ Œ¥‚Çê(e')\):
  \(‚üπ\) direction can be proved by applying \(Œ¥‚Çê\) to both sides:
  \[a e ‚â§ e' ‚üπ Œ¥‚Çê(a e) ‚â§ Œ¥‚Çê(e') ‚üπ e ‚â§ Œ¥‚Çê(e').\]
  \(‚ü∏\) direction proven by multiplying \(a\) on both sides:
  \[e ‚â§ Œ¥‚Çê(e') ‚üπ a e ‚â§ a Œ¥‚Çê(e') ‚üπ a e ‚â§ a Œ¥‚Çê(e') ‚â§ e'.\]
\end{proof}

\subsection{Decidability And Completeness}

In this section, we prove the completeness and decidability of the word inhabitance problem,
by explicitly define an algorithm to check for word inhabitance.

\begin{theorem}[Decidability and Completeness]\label{the: decidability and completeness of word inhabitant}
  Given a word \(w ‚àà \Word(X)\) and an expression \(e ‚àà \KA(X)\),
  we can define the following algorithm to test for inhabitants:
  \begin{align*}
    i & : \Word(X) √ó \KA(X) ‚Üí 2 \\  
    i & (œµ, e) ‚âú E(e) \\  
    i & (a ‚ãÖ w, e) ‚âú i(w, Œ¥‚Çê(e))
  \end{align*}
  Such an algorithm will always terminate,
  and it is sound:
  \[w ‚àà L(e) ‚ü∫ i(w, e) = 1 ‚ü∫ w ‚â§ e.\]
\end{theorem}

\begin{proof}
  The algorithm \(i\) will terminate because both \(Œ¥‚Çê\) and \(E\)
  can be computed by computing the interpretation \(I‚Çê\) and \(I_E\).

  We first show \(w ‚àà L(e) ‚ü∫ i(w, e)\) by induction on \(w\).
  \begin{itemize}
    \item If \(w = œµ\), then \(œµ ‚àà L(e) ‚ü∫ E(e) = 1\) by soundness of \(E\).
    \item If \(w = a ‚ãÖ w'\) then:
    \begin{align*}
      a ‚ãÖ w' ‚àà L(e) 
      & ‚ü∫ w' ‚àà Œ¥‚Çê(L(e)) 
        & \text{definition}\\  
      & ‚ü∫ w' ‚àà L(Œ¥‚Çê(e)) 
        & \text{soundness of \(Œ¥‚Çê\)} \\  
      & ‚ü∫ i(w, Œ¥‚Çê(e))
        & \text{induction hypothesis}
    \end{align*}
  \end{itemize}

  We then show \(i(w, e) = 1 ‚ü∫ w ‚â§ e\) by induction on \(w\).
  \begin{itemize}
    \item If \(w = œµ\), then \(i(œµ, e) = E(e)\).
      When \(E(e) = 1\), then \(1 = E(e) ‚â§ e\);  
      When \(E(e) = 0\), then \(1 ‚â∞ e\), 
      because \(1 ‚â§ e\) is not true in the language interpretation.
    \item If \(w = a ‚ãÖ w'\) then:
    \begin{align*}
      a ‚ãÖ w' ‚â§ e 
      & ‚ü∫ w' ‚â§ Œ¥‚Çê(e) 
        & \text{\Cref{the: Galois connection for derivative}} \\  
      & ‚ü∫ i(w, Œ¥‚Çê(e))
        & \text{induction hypothesis}
    \end{align*}
  \end{itemize}
\end{proof}


\subsection{Fundamental Theorem}

Fundamental theorem is an important soundness condition 
for the definition of derivative and empty word predicate,
it also exhibits a strong connection between KA and automata~\cite{Silva_2010,Kozen_Silva_2020}.
Because of the significance of the fundamental theorem,
we decide to prove it for KA with atomic commutativity,
despite it is not used in the rest of the paper.

In order to show the fundamental theorem for KA with atomic commutativity,
we will establish the relation between derivative and empty word predicate in KA 
with their counterparts in KA with commutativity,
and with this relation, we can show that fundamental theorem KA implies 
the fundamental theorem in KA with commutativity

Recall that for all commutable set \(X\), 
we can construct a discrete commutable set \(X_‚âÅ\) 
by replacing the commuting relation in \(X\) with the identity relation.
Notice that \(\KA(X_‚âÅ)\) is a free KA, and 
by \Cref{the: uniqueness of E and delta in free KA}, 
derivative and empty word predicate is unique on free KAs.
Since our definition of \(E\) and \(Œ¥‚Çê\) are sound, 
therefore they are exactly the conventional \(E\) and \(Œ¥‚Çê\) when applied to a term 
in the free KA.
Therefore, the fundamental theorem holds for \(\KA(X_‚âÅ)\):
\[‚àÄ e_‚âÅ ‚àà \KA(X_‚âÅ), e_‚âÅ = E(e_‚âÅ) + ‚àë_{a ‚àà X} a ‚ãÖ Œ¥‚Çê(e_‚âÅ).\]

Finally, there is a canonical KA homomorphism from \(\KA(X_‚âÅ)\) to \(\KA(X)\),
by lifting the following action on the primitives:
\[[a]_‚àº ‚âú a.\]
This KA homomorphism imposes the commutativity of \(X\) to the input expression, 
and this homomorphism is surjective.

\begin{lemma}
  Consider a Kleene Algebra \(ùí¶\) and an element \(t ‚àà ùí¶\),
  there is a homomorphism:
  \begin{align*}
    h & : D‚Çú(ùí¶) ‚Üí M_2(ùí¶) \\
    h & (\begin{bmatrix}
      p & q & r \\
      0 & s & 0 \\
      0 & 0 & s
    \end{bmatrix}) = 
    \begin{bmatrix}
      p & r \\
      0 & s
    \end{bmatrix}
  \end{align*}
\end{lemma}

\begin{proof}
  Perseverance of identities and addition is trivial,
  we will only check for perseverance of multiplication and star

  The multiplication case:
  \begin{align*}
    & h(\begin{bmatrix}
      p‚ÇÅ & q‚ÇÅ & r‚ÇÅ \\
      0 & s‚ÇÅ & 0 \\  
      0 & 0 & s‚ÇÅ
    \end{bmatrix}
    \begin{bmatrix}
      p‚ÇÇ & q‚ÇÇ & r‚ÇÇ \\
      0 & s‚ÇÇ & 0 \\  
      0 & 0 & s‚ÇÇ
    \end{bmatrix}) \\
    ={} & h(\begin{bmatrix}
      p‚ÇÅ p‚ÇÇ & p‚ÇÅq‚ÇÇ + q‚ÇÅs‚ÇÇ & p‚ÇÅ r‚ÇÇ + r‚ÇÅ s‚ÇÇ \\
      0 & s‚ÇÅ s‚ÇÇ & 0 \\  
      0 & 0 & s‚ÇÅ s‚ÇÇ
    \end{bmatrix}) \\
    = {}& \begin{bmatrix}
      p‚ÇÅ p‚ÇÇ& p‚ÇÅ r‚ÇÇ + r‚ÇÅ s‚ÇÇ \\
      0 & s‚ÇÅ s‚ÇÇ 
    \end{bmatrix} \\
    = {}& h(\begin{bmatrix}
      p‚ÇÅ & q‚ÇÅ & r‚ÇÅ \\
      0 & s‚ÇÅ & 0 \\  
      0 & 0 & s‚ÇÅ
    \end{bmatrix}) ‚ãÖ
    h(\begin{bmatrix}
      p‚ÇÇ & q‚ÇÇ & r‚ÇÇ \\
      0 & s‚ÇÇ & 0 \\  
      0 & 0 & s‚ÇÇ
    \end{bmatrix}).
  \end{align*}

  The star case:
  \begin{align*}
    h(\begin{bmatrix}
      p & q & r \\
      0 & s & 0 \\  
      0 & 0 & s
    \end{bmatrix}^*)
    & = 
    h(\begin{bmatrix}
      p^*  & p^*  q s^* & p^*  r s^* \\
      0 & s^* & 0 \\  
      0 & 0 & s^*
    \end{bmatrix})\\
    & = \begin{bmatrix}
      p^* & p^*  r s^* \\
      0 & s^* 
    \end{bmatrix}
    = h(\begin{bmatrix}
      p & q & r \\
      0 & s & 0 \\  
      0 & 0 & s
    \end{bmatrix})^*.
  \end{align*}
\end{proof}

Since the derivative \(Œ¥‚Çê(e)\) is defined as the \(1, 3\) component of \(I‚Çê(e)\),
after we apply above homomorphism \(h\) to \(I‚Çê(e)\),
the derivative \(Œ¥‚Çê(e)\) becomes the \(1, 2\) component of the matrix:
\[‚àÄ e ‚àà \KA(X), Œ¥‚Çê(e) = œÄ_{1, 2} (h(I‚Çê(e))).\]

\begin{lemma}\label{the: lemma for fundamental thoerem}
  Let \(X\) be a commutable set, for all non-commutativity expressions \(e_‚âÅ ‚àà \KA(X_‚âÅ)\):
  \[E([e_‚âÅ]_‚àº) = [E(e_‚âÅ)]_‚àº, \quad Œ¥‚Çê([e_‚âÅ]_‚àº) ‚â• [Œ¥‚Çê(e_‚âÅ)]_‚àº.\]
\end{lemma}

\begin{proof}
  Consider the following interpretations 
  \[I_E ‚àò [-]_‚àº \text{ and } [-]_‚àº ‚àò I_E: \KA(X_‚âÅ) ‚Üí \KA(X).\]
  Their actions coincide on the primitives:
  \[‚àÄ a ‚àà X_‚âÅ,
  I_E([a]_‚àº) = \begin{bmatrix}
    0 & a \\ 
    0 & a 
  \end{bmatrix} = [E(a)]_‚àº.\]
  Therefore, by \Cref{the: ordered of homomorphism is determined by order on the primitives},
  \[‚àÄ e_‚âÅ ‚àà \KA(X_‚âÅ), I_E([e_‚âÅ]_‚àº) = [I_E(e_‚âÅ)]_‚àº.\]
  Since \(E\) is a component of \(I_E\),
  \[E([e_‚âÅ]_‚àº) = [E(e_‚âÅ)]_‚àº.\]

  The same can be done for derivatives. 
  We consider the following interpretations:
  \[h ‚àò I_a ‚àò [-]_‚àº \text{ and } [-]_‚àº ‚àò h ‚àò I_a: \KA(X_‚âÅ) ‚Üí \KA(X).\]
  Given a primitive \(b\), 
  \begin{itemize}
    \item if \(b = a\), then 
      \[‚àÄ b ‚àà X_‚âÅ,
      h(I‚Çê([b]_‚àº)) = \begin{bmatrix}
        0 & 1 \\ 
        0 & b
      \end{bmatrix} = [h(I‚Çê(b))]_‚àº;\]
    \item if \(b ‚â† a\), then 
      \[h ‚àò I‚Çê([b]_‚àº) = \begin{cases}
        \begin{bmatrix}
          0 & 0 \\ 
          0 & b 
        \end{bmatrix} & b ‚âÅ a \text{ in \(X\)}\\
        \begin{bmatrix}
          b & 0 \\ 
          0 & b 
        \end{bmatrix} & b ‚àº a \text{ in \(X\)}
      \end{cases}\]
      both of which are greater than 
      \[[h(I‚Çê(b))]_‚àº = \begin{bmatrix}
        0 & 0 \\ 
        0 & b 
      \end{bmatrix} \quad \text{because \(b ‚âÅ a\) in \(X_‚âÅ\)}.\]
  \end{itemize}
  Therefore, for all primitive \(b ‚àà X_{‚âÅ}\), \(h(I‚Çê([b]_‚àº)) ‚â• [h(I‚Çê(b))]_‚àº\).
  By \Cref{the: ordered of homomorphism is determined by order on the primitives}
  \[‚àÄ e_‚âÅ ‚àà \KA(X_‚âÅ), h ‚àò I‚Çê([e_‚âÅ]_‚àº) ‚â• [h ‚àò I‚Çê(e_‚âÅ)]_‚àº.\]
  Since \(Œ¥‚Çê\) is a component of \(h ‚àò I‚Çê\), 
  \[Œ¥‚Çê([e_‚âÅ]_‚àº) ‚â• [Œ¥‚Çê(e_‚âÅ)]_‚àº.\qedhere\]
\end{proof}

The above lemma state that the derivative for commutative expression in \(\KA(X)\)
is always larger than their non-commutativity counterparts in \(\KA(X_‚âÅ)\).
Since \(\KA(X_‚âÅ)\) is a free KA, 
we can easily derive the fundamental theorem for \(\KA(X)\) 
using its connection with \(\KA(X_‚âÅ)\).

\begin{theorem}[Fundamental Thoerem]
  For all \(e ‚àà \KA(X)\), the following equality holds:
  \[e = E(e) + ‚àë_{a ‚àà X} a ‚ãÖ Œ¥‚Çê(e)\]
\end{theorem}

\begin{proof}
  We first show \(e ‚â• E(e) + ‚àë_{a ‚àà X} a ‚ãÖ Œ¥‚Çê(e)\),
  which is a direct consequence of decompositions in 
  \cref{the: decomposition of derivative and residual,the: empty word decomposition}:
  \begin{align*}
    e & ‚â• E(e),\\ 
    e & ‚â• a ‚ãÖ Œ¥‚Çê(e), ‚àÄ a ‚àà X.
  \end{align*}

  We then show \(e ‚â§ E(e) + ‚àë_{a ‚àà X} a ‚ãÖ Œ¥‚Çê(e)\).
  Since \([-]_‚àº\) is a surjective homomorphism, 
  we consider \(e_‚âÅ ‚àà \KA(X_‚âÅ)\) s.t. \([e_‚âÅ]_‚àº = e\).
  Because \(\KA(X_‚âÅ)\) is a free KA, fundamental theorem holds for \(e_‚âÅ\):
  \[e_‚âÅ ‚â§ E(e_‚âÅ) + ‚àë_{a ‚àà X} a ‚ãÖ Œ¥‚Çê(e_‚âÅ).\]
  We can apply the homomorphism \([-]_‚àº\) to both sides:
  \[e ‚â§ [E(e_‚âÅ)]_‚àº + ‚àë_{a ‚àà X} a ‚ãÖ [Œ¥‚Çê(e_‚âÅ)]_‚àº.\]
  By \Cref{the: lemma for fundamental thoerem},
  \begin{align*}
    [E(e_‚âÅ)]_‚àº & = E([e_‚âÅ]_‚àº) = E(e), \\  
    [Œ¥‚Çê(e_‚âÅ)]_‚àº & ‚â§ Œ¥‚Çê([e_‚âÅ]_‚àº) = Œ¥‚Çê(e).
  \end{align*}
  Thus, obtain the desired inequality:
  \[e ‚â§ [E(e_‚âÅ)]_‚àº + ‚àë_{a ‚àà X} a ‚ãÖ [Œ¥‚Çê(e_‚âÅ)]_‚àº ‚â§ E(e) + ‚àë_{a ‚àà X} a ‚ãÖ Œ¥‚Çê(e).\]
\end{proof}

\section{Undecidability}

In this section, we will show the undecidability result for general 
Kleene Algebra equalities with atomic commutativity hypotheses.
The undecidability result is obtained by using a proof to simulate 
the execution of a two-counter machine. 
From there, we can encode state reachability of terminating two-counter machines 
into an KA inequality. Enabling us to carry out a diagonal argument,
similar to the proof of undecidability of halting problem.

\subsection{Encoding Two-Counter Machines}

Counter machine is a well-studied machine~\cite{Minsky_1961,Minsky_1967,Lambek_1961},
and it can simulate any Turing machine~\cite[Theorem 14.1-1]{Minsky_1967} with just two counters.
In this paper, we only consider two-counter machines.
A two-counter machine \(M ‚âú (S, sÃÇ, Œπ)\) consists of a finite set of \emph{state} \(S\), 
a start state \(sÃÇ ‚àà S\), and each state is equipped with an instruction \(Œπ: S ‚Üí I_S\),
where instructions \(I_S\) is defined as follows:
\begin{align*}
  I_S & ‚âú \{ \Inc(s, q) ‚à£ s ‚àà \{1,2\}, q ‚àà Q \} \\
      & ‚à™ \{ \Dec(s, q) ‚à£ s ‚àà \{1,2\}, q ‚àà Q \} \\
      & ‚à™ \{ \If(s, q‚ÇÅ, q‚ÇÇ) ‚à£ s ‚àà \{1,2\}, q‚ÇÅ,q‚ÇÇ ‚àà Q \} \\
      & ‚à™ \{ \Halt \}.
\end{align*}
Each instruction has a semantics, we define \(S_‚ä• ‚âú S + \{‚ä•\}\):
\begin{align*}
  ‚ü¶i‚üß & : ‚Ñï √ó ‚Ñï ‚Üí S_‚ä• √ó ‚Ñï √ó ‚Ñï \\
  ‚ü¶\Inc(1,s)‚üß&(n, m) ‚âú (s,n+1,m) \\
  ‚ü¶\Inc(2,s)‚üß&(n, m) ‚âú (s,n,m+1) \\
  ‚ü¶\Dec(1,s)‚üß&(n, m) ‚âú (s,\max(n-1,0),m) \\
  ‚ü¶\Dec(2,s)‚üß&(n, m) ‚âú (s,n,\max(m-1,0)) \\
  ‚ü¶\If(1,q‚ÇÅ,q‚ÇÇ)‚üß&(n, m) ‚âú 
    \begin{cases}
      (s‚ÇÅ,n,m) & \text{if $n = 0$} \\
      (s‚ÇÇ,n,m) & \text{if $n ‚â† 0$}
    \end{cases} \\
  ‚ü¶\If(2,s‚ÇÅ,s‚ÇÇ)‚üß&(n, m) ‚âú 
    \begin{cases}
      (s‚ÇÅ,n,m) & \text{if $m = 0$} \\
      (s‚ÇÇ,n,m) & \text{if $m ‚â† 0$}
    \end{cases} \\
  ‚ü¶\Halt‚üß&(n,m) ‚âú (‚ä•, n, m).
\end{align*}

From the semantics of the instruction, 
we can define a transition relation for any machine \(M\):
\begin{align*}
  R_M & ‚àà (S √ó ‚Ñï √ó ‚Ñï) √ó (S_‚ä• √ó ‚Ñï √ó ‚Ñï) \\  
  R_M & ‚âú \{((s, m, n), ‚ü¶Œπ(s)‚üß(m, n)) ‚à£ s ‚àà S; m, n ‚àà ‚Ñï\}.
\end{align*}
Note that \(R_M\) is a functional relation, 
that is for all input \((s, m, n) ‚àà (S √ó ‚Ñï √ó ‚Ñï)\) there exists 
a unique element in \(S_‚ä• √ó ‚Ñï √ó ‚Ñï\) relating to it.
We call the elements in \(S_‚ä• √ó ‚Ñï √ó ‚Ñï\) \emph{configurations} of the machine \(M\).
Let \(R_M^*\) be the reflexive transition closure for \(R_M\),
and we write \(c ‚Üí^* c'\) if \((c, c') ‚àà R_M^*\).
We say a state \(s ‚àà S\) is \emph{reachable} from input \((n, m)\)
when there exists \(n', m' ‚àà ‚Ñï\), s.t. \((sÃÇ, m, n) ‚Üí^* (s, n', m')\).

Finally, we can consider a machine as a partial function,
we say that \(M(m, n)\) returns \((m', n')\) when \((sÃÇ, m, n) ‚Üí^* (‚ä•, n', m')\).
Since complex data structure can be encoded as a pair of numbers 
using the classical GoÃàdel numbers,
we will abuse the notation to say \(M(i)\) returns \(o\)
for input \(i\) and output \(o\) of arbitrary type, not just pairs of numbers.

Given a two-counter machine with finite state set \(S\),
We define the set \(Œ£ = S + \{‚ä•, a, b\}\) and the following commutable set \(Œ£Ãà\):
\begin{itemize}
  \item the carrier is \(‚ü®Œ£| ‚à™ |Œ£‚ü©\), 
    where \[‚ü®Œ£| ‚âú \{œÉ‚Çó ‚à£ œÉ ‚àà Œ£\} \text{ and } |Œ£‚ü© ‚âú \{œÉ·µ£ ‚à£ œÉ ‚àà Œ£\};\]
  \item the commuting relation is \(‚ü®œÉ| ‚àº |œÉ'‚ü©\), 
    where \(œÉ, œÉ' ‚àà Œ£\).
\end{itemize}
We call primitives in \(‚ü®Œ£|\) \emph{left primitives} and 
primitives in \(|Œ£‚ü©\) \emph{right primitives}.
This definition of commutativity is similar to BiKA~\cite{Antonopoulos_Koskinen_Le_Nagasamudram_Naumann_Ngo_2022},
however instead of using an underlying KA with two homomorphisms,
we simply impose the commutativity onto the primitives.
We consider \(Œ£\) as a discrete commutable set,
therefore we can define the free Kleene algebra \(\KA(Œ£)\) and 
the free KA with atomic commutative \(\KA(Œ£Ãà)\).

There are three function we can define from \(Œ£\) to \(\Word(Œ£Ãà)\):
\begin{align*}
  ‚ü®-|: & Œ£ ‚Üí \Word(Œ£Ãà) &  
  |-‚ü©: & Œ£ ‚Üí \Word(Œ£Ãà) & 
  ‚ü®-‚ü©: & Œ£ ‚Üí \Word(Œ£Ãà) \\  
  ‚ü®œÉ| & ‚âú œÉ‚Çó & 
  |œÉ‚ü© & ‚âú œÉ·µ£ & 
  ‚ü®œÉ‚ü© & ‚âú œÉ‚Çó ‚ãÖ œÉ·µ£.
\end{align*}

These maps can be lifted to monoidal homomorphism on words \(\Word(Œ£Ãà) ‚Üí \Word(Œ£Ãà)\):
\(‚ü®w|\) is the word \(w\) with all primitives replaced by corresponding left primitives
and \(|w‚ü©\) is the word \(w\) with all primitives replaced by corresponding right primitives.

By composing \(‚ü®-|, |-‚ü©, ‚ü®-‚ü©\) with the natural monoidal embedding \(\Word(Œ£Ãà) ‚Üí \KA(Œ£Ãà)\), 
where the monoidal operation of \(\KA(Œ£Ãà)\) is multiplication with identity \(1\),
we can obtain functions in \(Œ£ ‚Üí \KA(Œ£Ãà)\).
Similarly, these maps can be lifted to KA homomorphisms \(\KA(Œ£) ‚Üí \KA(Œ£Ãà)\):
\begin{itemize}
  \item \(‚ü®e|\) and \(|e‚ü©\) will replace all the primitives in \(e\)
    with their respective left primitives or right primitives.
  \item \(‚ü®e‚ü©\) will produce two expression with \emph{matching} left and right primitives. 
\end{itemize}
We will abbreviate the multiplication \(‚ü® e‚ÇÅ | ‚ãÖ | e‚ÇÇ ‚ü©\) as \(‚ü® e‚ÇÅ | e‚ÇÇ ‚ü©\).

\begin{example}
  Consider \(a ‚àà Œ£\), then \(‚ü®a^*‚ü© ‚àà \KA(Œ£Ãà)\) and 
  \[L(‚ü®a^*‚ü©) = \{‚ü®a^n | a^n ‚ü© ‚à£ n ‚àà ‚Ñï\}.\]
  More generally, given an expression \(e ‚àà \KA(Œ£)\), 
  then \(‚ü®e‚ü© ‚àà \KA(Œ£Ãà)\) and 
  \[L(‚ü®e‚ü©) = \{ ‚ü®w | w‚ü© ‚à£ w ‚àà L(e)\}.\]
\end{example}

For a word in \(\Word(Œ£Ãà)\) we can always canonically separate it into 
its left and right components,
this separation gives a normal form for all the words in \(\Word(Œ£Ãà)\).

\begin{definition}
  For a word \(w\), the \emph{left component} \(‚ü®w‚Çó|\) is the word formed 
  by all the left primitives in its original order,
  and the \emph{right component} \(|w·µ£‚ü©\) is the word formed 
  by all the right primitives in its original order.
  The concatenation of the left component and the right component 
  is equal to the original word.
  Therefore, for all word \(w, w' ‚àà \Word(Œ£Ãà)\),
  \[w = w' ‚ü∫ w·µ£ = w·µ£' ‚àß w‚Çó = w‚Çó'.\]
\end{definition}

\begin{example}
  Consider the following word \[w ‚âú ‚ü® s | s' ‚ü© ‚ãÖ ‚ü®a·µê b‚Åø | a^{m+1} b‚Åø ‚ü©,\]
  then its left component \(‚ü®w‚Çó| = ‚ü®s a·µê b‚Åø|\) 
  and the right component is \(|w·µ£‚ü© = |s' a^{m+1} b‚Åø‚ü©\).
  The concatenation of right and left component is equal to the original word:
  \[‚ü®w‚Çó | w·µ£ ‚ü© = ‚ü®s a·µê b‚Åø|s' a^{m+1} b‚Åø‚ü© = ‚ü® s | s' ‚ü© ‚ãÖ ‚ü®a·µê b‚Åø | a^{m+1} b‚Åø ‚ü©.\]
\end{example}

We first show couple useful lemmas about \(\KA(Œ£)\) and \(\KA(Œ£Ãà)\):
\begin{lemma}
  We first prove several lemmas that will be useful in our derivation.
  For all \(e, e‚ÇÅ, e‚ÇÇ, e‚ÇÅ', e‚ÇÇ' ‚àà \KA(Œ£)\) 
  \begin{align}
    ‚ü® e‚ÇÅ | e‚ÇÇ ‚ü© & = | e‚ÇÇ ‚ü© ‚ãÖ ‚ü® e‚ÇÅ |; \\
    ‚ü® e‚ÇÅ | e‚ÇÇ ‚ü© ‚â§ ‚ü® e‚ÇÅ' | e‚ÇÇ' ‚ü© & ‚ü∫ e‚ÇÅ ‚â§ e‚ÇÅ' ‚àß e‚ÇÇ ‚â§ e‚ÇÇ'; 
      \label[ineq]{the: left right order decompose}\\
    ‚ü®e^*‚ü© & ‚â§ ‚ü®e^*|e^*‚ü©. \label[ineq]{the: matching star less than left right star}
  \end{align}
\end{lemma}

\begin{proof}
  \(‚ü® e‚ÇÅ | e‚ÇÇ ‚ü© = | e‚ÇÇ ‚ü© ‚ãÖ ‚ü® e‚ÇÅ |\) can be derived by induction on 
  structure of \(e‚ÇÅ\), the only non-trivial case is the star case,
  which can be proven using the induction rule.

  The equivalence
  \[‚ü® e‚ÇÅ | e‚ÇÇ ‚ü© ‚â§ ‚ü® e‚ÇÅ' | e‚ÇÇ' ‚ü© ‚ü∫ e‚ÇÅ ‚â§ e‚ÇÅ' ‚àß e‚ÇÇ ‚â§ e‚ÇÇ'\]
  can be derived as follows:
  The \(‚ü∏\) part can be shown by multiplication preserves order.
  The \(‚üπ\) part can be shown by looking at the language interpretation:
  if \(L(e‚ÇÅ) ‚â∞ L(e‚ÇÅ')\) or \(L(e‚ÇÇ) ‚â∞ L(e‚ÇÇ')\),
  then we can derive
  \[L(‚ü® e‚ÇÅ | e‚ÇÇ ‚ü©) ‚â∞ L(‚ü® e‚ÇÅ' | e‚ÇÇ' ‚ü©)\]

  \(‚ü®e^*‚ü© ‚â§ ‚ü®e^*|e^*‚ü©\) can be shown by induction rule,
  because
  \begin{align*}
    ‚ü®e^*|e^*‚ü© & ‚â• 1,\\  
    ‚ü®e^*|e^*‚ü© & ‚â• ‚ü®e e^*| e e^*‚ü© = ‚ü®e|e‚ü© ‚ãÖ ‚ü®e^*|e^*‚ü© = ‚ü®e‚ü© ‚ãÖ ‚ü®e^*|e^*‚ü©,  
  \end{align*}
  by induction rule \(‚ü®e^*|e^*‚ü© ‚â• ‚ü®e^*‚ü©\).
\end{proof}


We can encode components of the machine as Kleene Algebra terms.
\begin{definition}\label{def:instruction-interpretation}
  For simplicity, we will implicitly coerce all the configuration 
  into an expression in \(\KA(Œ£)\) in the following way:
  for \(s ‚àà S_‚ä•\),
  \begin{align*}
    (s, m, n) & ‚Ü¶ s a·µê b‚Åø.
  \end{align*}

  We interpret each instruction $i ‚àà I_S$ as an element $[i] ‚àà \KA(Œ£Ãà)$ as follows.
  \begin{align*}
    [\Inc(1,s)] & ‚âú |s‚ü© ‚ü®a^*‚ü© |a‚ü© ‚ü®b^*‚ü© \\
    [\Inc(2,s)] & ‚âú |s‚ü©‚ü®a^* b^*‚ü©|b‚ü© \\
    [\Dec(1,s)] & ‚âú |s‚ü©‚ü®a^*‚ü©‚ü®a|‚ü®b^*‚ü© + |s‚ü©‚ü®b^*‚ü© \\
    [\Dec(2,s)] & ‚âú |s‚ü©‚ü®a^* b^*‚ü©‚ü®b| + |s‚ü©‚ü®a^*‚ü© \\
    [\If(1,s‚ÇÅ,s‚ÇÇ)] & ‚âú |s‚ÇÅ‚ü©‚ü®b^*‚ü© + |s‚ÇÇ‚ü©‚ü®a‚Å∫‚ü©‚ü®b^*‚ü© \\
    [\If(2,s‚ÇÅ,s‚ÇÇ)] & ‚âú |s‚ÇÅ‚ü©‚ü®a^*‚ü© + |s‚ÇÇ‚ü©‚ü®a^*‚ü©‚ü®b‚ü©‚Å∫ \\
    [\Halt] & ‚âú |‚ä•‚ü© ‚ü®a^* b^*‚ü©.
  \end{align*}
  The transition relation is encoded as \(R_M ‚àà \KA(Œ£Ãà)\):
  \[R_M ‚âú ‚àë_{s ‚àà S} ‚ü®s| ‚ãÖ [Œπ(s)].\]
\end{definition}

The reason for such encoding is apparent when we look the language interpretation:
\begin{corollary}[Language Soundness]\label{the: language encoding soundness of machine}
  Given a machine \(M ‚âú (S, sÃÇ, Œπ)\), \(c ‚àà S √ó ‚Ñï √ó ‚Ñï\), and \(c' ‚àà S_‚ä• √ó ‚Ñï √ó ‚Ñï\), 
  the following equivalence holds
  \begin{align}
    ‚ü¶i‚üß(m, n) = c' & ‚ü∫ ‚ü®a·µê b‚Åø | c'‚ü© ‚àà L([i]);\label[equiv]{the: instruction language soundness}\\
    c ‚Üí c' & ‚ü∫ ‚ü®c | c'‚ü© ‚àà L(R_M).\label[equiv]{the: transition language soundness}
  \end{align}
\end{corollary}

\begin{proof}
  The equivalence
  \[‚ü¶i‚üß(m, n) = c' ‚ü∫ ‚ü®a·µê b‚Åø | c' ‚ü© ‚àà L([i])\]
  can be shown by looking at each case of instruction \(i\), 
  and explicitly compute the language model for each instruction.

  Therefore,
  \begin{align*}
    & (s, m, n) ‚Üí (s', m', n') \\
    & ‚ü∫ (s', m', n') = ‚ü¶Œπ(s)‚üß(m, n) \\
    & ‚ü∫ ‚ü®a·µê b‚Åø | s' a^{m'} b^{n'} ‚ü© ‚àà L([Œπ(s)]) \\  
    & ‚ü∫ ‚ü® s a·µê b‚Åø | s' a^{m'} b^{n'} ‚ü© ‚àà L(‚ü®s| ‚ãÖ [Œπ(s)]) \\  
    & ‚ü∫ ‚ü® s a·µê b‚Åø | s' a^{m'} b^{n'} ‚ü© ‚àà L(R_M). \qedhere
  \end{align*}
\end{proof}

\begin{corollary}\label{the: transition encoding is functional}
  Because the transition relation of any machine \(M = (S, sÃÇ, Œπ)\) is functional,
  therefore for all word \(w ‚àà L(S a^* b^*)\), 
  there exists a word \(w' ‚àà L(S_‚ä• a^* b^*)\)
  s.t. \(‚ü®w | w'‚ü© ‚àà L(R_M)\).
\end{corollary}


\subsection{From Reachability to Undecidability}

Our undecidability result relies on an equivalence between provability of 
a KA inequality and state reachability in a certain kind of machine.
In order to obtain such equivalence,
we will start with the provability of a single transition.

We will first define two useful terms.
For a machine \(M ‚âú (S, sÃÇ, Œπ)\), and a subset of states \(S' ‚äÜ S\), 
we can define all the configuration for \(S'\) including termination:
\begin{align*}
  C_{S'} & ‚àà \KA(Œ£) \\
  C_{S'} & ‚âú S'_‚ä• a^*b^*.
\end{align*}
And the term \(N_S\) representing left-right configuration mismatch:
\begin{align*}
  N_S & ‚àà \KA(Œ£Ãà) \\
  N_S & ‚âú ‚àë_{s ‚â† s' ‚àà S} ‚ü®s| s'‚ü© (‚ü®a+b|+|a+b‚ü©)^* & \text{state mismatch} \\
    & + ‚ü®S‚ü© ‚ü®a^*‚ü© (‚ü®a|‚Å∫ + |a‚ü©‚Å∫) ‚ü®b^* | b^*‚ü© & \text{counter \(a\) mismatch} \\  
    & + ‚ü®S‚ü© ‚ü®a^* b^*‚ü© (‚ü®b|‚Å∫ + |b‚ü©‚Å∫) & \text{counter \(b\) mismatch} \\
\end{align*}

And we can use these terms to bound the encoding of transition \(R_M\):
\begin{lemma}
  For all instructions \(i ‚àà I_S\) and transition \(R_M ‚àà \KA(Œ£Ãà)\),
  let \(S\) be the state set of \(M\):
  \begin{align}
    [i] & ‚â§ ‚ü®a^* b^* | C_S‚ü© = ‚ü®a^* b^* | S_‚ä• ‚ãÖ a^* b^*‚ü©; \label[ineq]{the: upper bound encoding instruction}\\
    R_M & ‚â§ ‚ü®C_S ‚à£ C_S‚ü© = ‚ü®S_‚ä• ‚ãÖ a^* b^* | S_‚ä• ‚ãÖ a^* b^*‚ü©. \label[ineq]{the: upper bound encoding transition}
  \end{align}
\end{lemma}

\begin{proof}
  The first inequality can be proven by looking at each case of \(i\),
  and apply \Cref{the: matching star less than left right star}
  when necessary.

  The second inequality can be proven by unfolding the definition of \(R_M\):
  \begin{align*}
    R_M & = ‚àë_{s ‚àà S} ‚ü®s| ‚ãÖ [Œπ(s)] \\
    & ‚â§ ‚àë_{s ‚àà S} ‚ü®s| ‚ãÖ ‚ü®a^* b^* | S_‚ä• ‚ãÖ a^* b^*‚ü© 
      & \text{by \Cref{the: upper bound encoding instruction}}\\
    & ‚â§ ‚ü®S ‚ãÖ a^* b^* | S_‚ä• ‚ãÖ a^* b^*‚ü© ‚â§ ‚ü®C_S ‚à£ C_S‚ü©. 
  \end{align*}
\end{proof}

With the above tools in place, 
we will establish the connection of provability and a single transition.
\begin{theorem}[provability of single transition]\label{the: single step transition soundness}
  In any machine \(M\), \((s, m, n) ‚Üí (s', m', n')\) 
  if and only if the following inequality is provable:
  \[| s a·µê b‚Åø ‚ü© R_M ‚â§ ‚ü®C_S‚ü© ‚ãÖ |s' a^{m'} b^{n'}‚ü© + N_S ‚ãÖ |C_{S}‚ü©.\]
\end{theorem}

\begin{proof}
  To prove the \(‚üπ\) direction, 
  we will first unfold definition of the left-hand side:
  \begin{align*}
    & | s a·µê b‚Åø ‚ü© R_M \\
    & = | s a·µê b‚Åø ‚ü© ‚ãÖ (‚àë_{s‚ÇÅ ‚àà S} ‚ü®s‚ÇÅ| ‚ãÖ [Œπ(s‚ÇÅ)]) \\   
    & = ‚àë_{s‚ÇÅ ‚àà S} | s a·µê b‚Åø ‚ü© ‚ãÖ ‚ü®s‚ÇÅ| ‚ãÖ [Œπ(s‚ÇÅ)] \\  
    & = ‚ü®s| s a·µê b‚Åø ‚ü© ‚ãÖ [Œπ(s)] + ‚àë_{s‚ÇÅ ‚â† s} ‚ü®s‚ÇÅ| s a·µê b‚Åø ‚ü© ‚ãÖ [Œπ(s‚ÇÅ)].
  \end{align*}
  It suffices to show the following inequalities:
  \begin{align*}
    ‚ü®s| s a·µê b‚Åø ‚ü© ‚ãÖ [Œπ(s)] & ‚â§ ‚ü®C_S‚ü© |s' a^{m'} b^{n'}‚ü© + N_S |C_S‚ü©; \\  
    ‚àë_{s‚ÇÅ ‚â† s} ‚ü®s‚ÇÅ| s a·µê b‚Åø ‚ü© ‚ãÖ [Œπ(s‚ÇÅ)] & 
      ‚â§ ‚ü®C_S‚ü© |s' a^{m'} b^{n'}‚ü© + N_S |C_S‚ü©.
  \end{align*}

  We show the second inequality first:
  \begin{align*}
    & ‚àë_{s‚ÇÅ ‚â† s} ‚ü®s‚ÇÅ| s a·µê b‚Åø ‚ü© ‚ãÖ [Œπ(s‚ÇÅ)] \\   
    & ‚â§ ‚àë_{s‚ÇÅ ‚â† s} ‚ü®s‚ÇÅ| s a·µê b‚Åø ‚ü© ‚ãÖ ‚ü®a^* b^*|C_S‚ü© \\  
    & ‚â§ ‚àë_{s ‚â† s' ‚àà S} ‚ü®s|s'‚ü© (‚ü®a+b|+|a+b‚ü©)^* |C_S‚ü©\\
    & ‚â§ N_S |C_S‚ü© ‚â§ ‚ü®C_S‚ü© |s' a^{m'} b^{n'}‚ü© + N_S |C_S‚ü©,
  \end{align*}

  To show the first inequality:
  \[‚ü®s| s a·µê b‚Åø ‚ü© ‚ãÖ [Œπ(s)] ‚â§ ‚ü®C_S‚ü© |s' a^{m'} b^{n'}‚ü© + N_S |C_S‚ü©.\] 
  We need to look at all the cases for \(Œπ(s)\),
  we show the \(\If(1, s)\) case as examples:
  \begin{itemize}
    \item If \(Œπ(s) = \If(1, s‚ÇÅ', s‚ÇÇ')\) and \(m = 0\),
      then \((s, 0, n) ‚Üí (s‚ÇÅ', 0, n)\):
      \begin{align*}
        & ‚ü®s | s b‚Åø‚ü© ‚ãÖ [Œπ(s)] \\
        & = ‚ü®s |s b‚Åø‚ü© ‚ãÖ (|s‚ÇÅ'‚ü© ‚ü®b^*‚ü© + |s‚ÇÇ'‚ü© ‚ü®a‚Å∫‚ü©‚ü®b^*‚ü©) \\[5px]
        & = ‚ü®s |s b‚Åø‚ü© ‚ãÖ |s‚ÇÅ'‚ü© ‚ãÖ (‚àë_{i ‚â§ n} ‚ü®b‚Å±‚ü© + ‚ü®b‚Åø‚ü© ‚ãÖ ‚ü®b‚Å∫‚ü©) \\
        & \qquad + ‚ü®s | s b‚Åø‚ü© ‚ãÖ |s‚ÇÇ'‚ü© ‚ãÖ ‚ü®a‚Å∫‚ü©‚ü®b^*‚ü© \\[5px]
        & = (‚àë_{i < n} ‚ü®s b‚Å±|s b‚Åø‚ü© |s‚ÇÅ' b‚Å±‚ü©) 
          + ‚ü® s b‚Åø | s b‚Åø ‚ü© ‚ãÖ |s‚ÇÅ' b‚Åø ‚ü© \\
        & \qquad + ‚ü® s b‚Åø b | s b‚Åø‚ü© |s‚ÇÅ' b‚Åø b‚ü©‚ü®b^*‚ü© \\  
        & \qquad + ‚ü®s a | s b‚Åø‚ü© ‚ãÖ |s‚ÇÇ' a‚ü© ‚ãÖ ‚ü®a^* b^*‚ü©
      \end{align*}
      Notice:
      \begin{align*}
        ‚àë_{i < n} ‚ü®s b‚Å±|s b‚Åø‚ü© |s‚ÇÅ' b‚Å±‚ü© & ‚â§ ‚ü®S‚ü© ‚ü®a^* b^*‚ü© |b‚Å∫‚ü© ‚ãÖ |C_S‚ü© ‚â§ N_S ‚ãÖ |C_S‚ü©; \\
        ‚ü® s b‚Åø | s b‚Åø ‚ü© ‚ãÖ |s‚ÇÅ' b‚Åø ‚ü© & ‚â§ ‚ü®C_S‚ü© ‚ãÖ |s‚ÇÅ' b‚Åø‚ü©;\\
        ‚ü® s b‚Åø b | s b‚Åø ‚ü© |s‚ÇÅ' b‚Åø b‚ü©‚ü®b^*‚ü© 
            & ‚â§ ‚ü® s b‚Åø b | s b‚Åø ‚ü© |s‚ÇÅ' b‚Åø b‚ü©‚ü®b^* | b^*‚ü© \\  
            & ‚â§ ‚ü® s b‚Åø b b^*| s b‚Åø ‚ü© |s‚ÇÅ' b‚Åø b b^*‚ü© \\  
            & ‚â§ ‚ü®S‚ü© ‚ü®a^* b^*‚ü© ‚ü®b‚Å∫| ‚ãÖ |C_S‚ü© ‚â§ N_S ‚ãÖ |C_S‚ü©; \\  
        ‚ü®s a | s b‚Åø‚ü© ‚ãÖ |s‚ÇÇ' a‚ü© ‚ãÖ ‚ü®a^* b^*‚ü© 
            & ‚â§ ‚ü®s a | s b‚Åø‚ü© ‚ãÖ |s‚ÇÇ' a‚ü© ‚ãÖ ‚ü®a^* | a^*‚ü©‚ü®b^* | b^*‚ü© \\  
            & ‚â§ ‚ü®s a a^* b^*| s b‚Åø‚ü© ‚ãÖ |s‚ÇÇ' a b^* a^*‚ü© \\  
            & ‚â§ ‚ü®S‚ü© ‚ü®a^*‚ü© ‚ü®a|‚Å∫ ‚ü®b^* | b^*‚ü© ‚ãÖ |C_S‚ü© \\
            & ‚â§ N_S ‚ãÖ |C_S‚ü©.
      \end{align*}
      Thus, we obtain the inequality we desire:
      \[| s a·µê b‚Åø ‚ü© ‚ãÖ ‚ü®s| ‚ãÖ [Œπ(s)] ‚â§ ‚ü®C_S‚ü© ‚ãÖ |s‚ÇÅ' b‚Åø‚ü© + N_S |C_S‚ü©.\]
    \item If \(Œπ(s) = \If(1, s‚ÇÅ', s‚ÇÇ')\) and \(m ‚â† 0\),
      then \((s, m, n) ‚Üí (s‚ÇÇ', m, n)\), and the proof is similar to above:
      \begin{align*}
        & ‚ü®s|s a·µê b‚Åø‚ü© ‚ãÖ [Œπ(s)] \\
        & = ‚ü®s|s a·µê b‚Åø‚ü© ‚ãÖ (|s‚ÇÅ'‚ü© ‚ü®b^*‚ü© + |s‚ÇÇ'‚ü© ‚ü®a‚Å∫b^*‚ü©) \\[5px]
        & = ‚ü®s |s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÅ'‚ü© ‚ü®b^*‚ü© \\
        & \qquad + ‚ü®s | s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ'‚ü© ‚ãÖ 
            (‚àë_{i ‚â§ m, j ‚â§ n}‚ü®a‚Å± b ≤‚ü© + ‚ü®a·µê a‚Å∫ b‚Åø b‚Å∫‚ü©) \\[5px]
        & = ‚ü®s |s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÅ'‚ü© ‚ü®b^*‚ü© \\
        & \qquad + (‚àë_{i < m, j ‚â§ n} ‚ü®s a‚Å± b ≤| s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ' a‚Å± b ≤‚ü©) \\  
        & \qquad + (‚àë_{i = m, j ‚â§ n} ‚ü®s a‚Å± b ≤| s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ'a‚Å± b ≤‚ü©) \\  
        & \qquad + ‚ü®s a·µê b‚Åø| s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ'a·µê b‚Åø‚ü© \\
        & \qquad + ‚ü®s a·µê a‚Å∫ b‚Åø b‚Å∫|s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÅ' a·µê a‚Å∫ b‚Åø b‚Å∫‚ü©
      \end{align*}
      Then we obtain the following inequality
      \begin{align*}
        ‚ü®s |s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÅ'‚ü© ‚ü®b^*‚ü© 
          & ‚â§ ‚ü®s b^* |s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÅ' b^*‚ü© \\
          & ‚â§ ‚ü®S‚ü© ‚ü®a^*‚ü© |a‚ü©‚Å∫ ‚ü®b^* | b^*‚ü© ‚ãÖ |C_S‚ü© \\  
          & ‚â§ N_S |C_S‚ü©; \\ 
        (‚àë_{i < m, j ‚â§ n} ‚ü®s a‚Å± b ≤| s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ' a‚Å± b ≤‚ü©) 
          & ‚â§ ‚ü®S‚ü© ‚ü®a^*‚ü© |a‚ü©‚Å∫ ‚ü®b^* | b^*‚ü© ‚ãÖ |C_S‚ü© \\  
          & ‚â§ N_S |C_S‚ü©; \\
        (‚àë_{i = m, j ‚â§ n} ‚ü®s a‚Å± b ≤| s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ'a‚Å± b ≤‚ü©)
          & ‚â§ ‚ü®S‚ü© ‚ü®a^* b^*‚ü© |b‚ü©‚Å∫ ‚ãÖ |C_S‚ü©\\  
          & ‚â§ N_S |C_S‚ü©; \\  
        ‚ü®s a·µê b‚Åø| s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÇ'a·µê b‚Åø‚ü© 
          & ‚â§ ‚ü®C_S‚ü© ‚ãÖ |s‚ÇÇ' a·µê b‚Åø‚ü©;  \\
        ‚ü®s a·µê a‚Å∫ b‚Åø b‚Å∫|s a·µê b‚Åø‚ü© ‚ãÖ |s‚ÇÅ' a·µê a‚Å∫ b‚Åø b‚Å∫‚ü©
          & ‚â§ ‚ü®S‚ü© ‚ü®a^*‚ü© |a‚ü©‚Å∫ ‚ü®b^* | b^*‚ü© ‚ãÖ |C_S‚ü© \\  
          & ‚â§ N_S |C_S‚ü© 
        \end{align*}
      Thus, we obtain the inequality we desire:
      \[| s a·µê b‚Åø ‚ü© ‚ãÖ ‚ü®s| ‚ãÖ [Œπ(s)] ‚â§ ‚ü®C_S‚ü© ‚ãÖ |s‚ÇÇ' a·µê b‚Åø‚ü© + N_S |C_S‚ü©.\]
  \end{itemize}

  The \(‚ü∏\) direction can be shown by looking at the language model.
  If the inequality holds, then the language interpretation holds:
  \[| s a·µê b‚Åø ‚ü© L(R_M) ‚äÜ L(‚ü®C_S‚ü©) ‚ãÖ |s' a^{m'} b^{n'}‚ü© + L(N_S) ‚ãÖ L(|C_{S}‚ü©).\]

  By \Cref{the: transition encoding is functional},
  there exists a word \(w ‚àà L(R_M)\) s.t. its left component is \(‚ü® s a·µê b‚Åø |\);
  we write the right component of \(w\) as \(|w·µ£‚ü©\).
  By \Cref{the: decidability and completeness of word inhabitant}, \(w ‚â§ R_M\); and
  by \Cref{the: upper bound encoding transition,the: left right order decompose},
  \[‚ü® s a·µê b‚Åø | w·µ£‚ü© ‚â§ R_M ‚â§ ‚ü®C_S|C_S‚ü© ‚üπ w·µ£ ‚â§ C_S.\]
  Therefore, \(w·µ£ ‚àà L(C_S)\) and by the definition of \(L(N_S) ‚ãÖ L(|C_{S}‚ü©)\),
  \[| s a·µê b‚Åø ‚ü© ‚ãÖ ‚ü® s a·µê b‚Åø | w·µ£ ‚ü© = ‚ü® s a·µê b‚Åø | s a·µê b‚Åø ‚ü© ‚ãÖ | w·µ£ ‚ü© ‚àâ L(N_S) ‚ãÖ L(|C_{S}‚ü©).\]

  Because of the language inclusion
  \[| s a·µê b‚Åø ‚ü© L(R_M) ‚äÜ L(‚ü®C_S‚ü©) ‚ãÖ |s' a^{m'} b^{n'}‚ü© + L(N_S) ‚ãÖ L(|C_{S}‚ü©),\]
  we have
  \[‚ü® s a·µê b‚Åø | s a·µê b‚Åø ‚ü© ‚ãÖ | w·µ£ ‚ü© ‚àà L(‚ü®C_S‚ü©) ‚ãÖ |s' a^{m'} b^{n'}‚ü©\]
  therefore \(w·µ£ = s' a^{m'} b^{n'}\), and by \Cref{the: transition language soundness}:
  \[w = ‚ü® s a·µê b‚Åø | s' a^{m'} b^{n'}‚ü© ‚àà R_M  
  ‚üπ (s, m, n) ‚Üí (s', m', n').\]
\end{proof}

We can further extend our previous result to establish a connection 
between provability and state reachability in certain type of machines. 
This result will be the core of our diagonal argument.

\begin{theorem}
  For a machine \(M ‚âú (S, sÃÇ, Œπ)\) and an input \((m, n)\), 
  if the set of reachable configurations from the input is finite,
  then a set \(S' ‚äÜ S\) contains all the reachable states from input \((m, n)\) 
  if and only if the following inequality is provable:
  \begin{align}
    |sÃÇ a‚Åø b·µê‚ü© R_M^* ‚â§ ‚ü®C_S^*‚ü© |C_{S'}‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©.
    \label[ineq]{ineq: reachability inequality}
  \end{align}
\end{theorem}
\begin{proof}
  The \(‚üπ\) direction.
  We define the following term:
  \[\KA(Œ£) ‚àã C·µ£ ‚âú ‚àë \{c·µ£ ‚à£ \text{\(c·µ£\) is reachable}\}.\]
  \(C·µ£\) is well-defined because there are only finitely many reachable configurations.
  By \Cref{the: single step transition soundness}, 
  assume \(c·µ£ ‚Üí c·µ£'\), we have the following inequality:
  \begin{align*}
    |c·µ£‚ü© R_M 
    & ‚â§ ‚ü®C_S‚ü© |c·µ£'‚ü© + N_S |C_S‚ü© \\ 
    & ‚â§ ‚ü®C_S‚ü© |C·µ£‚ü© + N_S |C_S‚ü© & \text{\(c·µ£'\) is reachable}
  \end{align*}
  Since the above inequality is true for every reachable configuration \(c·µ£\),
  then the following inequality is true:
  \[|C·µ£‚ü© R_M  = ‚àë_{c·µ£} |c·µ£‚ü© R_M ‚â§ ‚ü®C_S‚ü© |C·µ£‚ü© + N_S |C_S‚ü©.\]

  To show provability of \Cref{ineq: reachability inequality}, 
  we will prove a stronger inequality:
  \[|sÃÇ a‚Åø b·µê‚ü© R_M^* ‚â§ ‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©.\]
  With \Cref{the: single step transition soundness,the: upper bound encoding transition},
  we can derive the following two inequality:
  \begin{align*}
    ‚ü®C_S^*‚ü© |C·µ£‚ü© R_M 
      & ‚â§ ‚ü®C_S^*‚ü© ‚ü®C_S‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S |C_S‚ü© \\
      & ‚â§ ‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü© \\
    ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü© R_M
      & ‚â§ ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü© ‚ü®C_S | C_S‚ü© \\
      & ‚â§ ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü© \\  
      & ‚â§ ‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©.
  \end{align*}
  Therefore,
  \begin{align*}
    & (‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©) R_M  \\
      & \qquad ‚â§ ‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©; \\
    & |sÃÇ a‚Åø b·µê‚ü© ‚â§ |C·µ£‚ü© \\  
    & \qquad ‚â§ ‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©.
  \end{align*}
  By induction rule, we have the desired inequality:
  \begin{align*}
    |sÃÇ a‚Åø b·µê‚ü© R_M^* 
    & ‚â§ ‚ü®C_S^*‚ü© |C·µ£‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü© \\  
    & ‚â§ ‚ü®C_S^*‚ü© |C_{S'}‚ü© + ‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©.
  \end{align*}

  The \(‚ü∏\) direction.
  We will first prove a small lemma: 
  consider a configuration \(c·µ£\) that is reachable from input \((m, n)\),
  we will show there exists a word \(w ‚àà L(‚ü®C_S^*‚ü©)\) s.t.
  \[w |c·µ£‚ü© ‚àà L(|sÃÇ a‚Åø b·µê‚ü©) L(R_M)^*.\]
  The theorem above is shown by induction on the number of steps to reach \(c·µ£\):
  \begin{itemize}
    \item If \(c·µ£\) is reached in 0 steps, 
      then \[c·µ£ = (sÃÇ, m, n).\]
      In this case, \(w = œµ\) and 
      \[|c·µ£‚ü© = |sÃÇ a‚Åø b·µê‚ü© ‚àà L(|sÃÇ a‚Åø b·µê‚ü©) L(R_M)^*.\]
    \item If \(c·µ£\) is reached in \(n+1\) steps,
      we find the configuration \(c·µ£'\) that is reached in \(n\) steps: 
      \[(sÃÇ, m, n) ‚Üí^* c·µ£' ‚Üí c·µ£.\]
      By induction hypothesis, there is \(w ‚àà L(‚ü®C_S^*‚ü©)\), s.t.
      \[w |c·µ£'‚ü© ‚àà L(|sÃÇ a‚Åø b·µê‚ü©) L(R_M)^*.\]
      By \Cref{the: language encoding soundness of machine},
      \[c·µ£' ‚Üí c·µ£ ‚üπ ‚ü®c·µ£' | c·µ£‚ü© ‚àà L(R_M).\]
      We have obtained our desired word:
      \[w |c·µ£'‚ü© ‚ãÖ ‚ü®c·µ£' | c·µ£‚ü© = w ‚ü®c·µ£'|c·µ£'‚ü© | c·µ£‚ü© ‚àà L(|sÃÇ a‚Åø b·µê‚ü©) L(R_M)^*.\]
  \end{itemize}

  Consider \(w ‚àà L(‚ü®C_S^*‚ü©)\) s.t.
  \(w |c·µ£‚ü© ‚àà L(|sÃÇ a‚Åø b·µê‚ü©) L(R_M)^*,\) by definition
  \[w |c·µ£‚ü© ‚àâ L(‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©).\]
  Because \Cref{ineq: reachability inequality} holds, 
  we have the following language inclusion:
  \[L(|sÃÇ a‚Åø b·µê‚ü©) L(R_M)^* ‚äÜ L(‚ü®C_S^*‚ü©) L(|C_{S'}‚ü©) + L(‚ü®C_S^*‚ü© N_S ‚ü®C_S^* | C_S^*‚ü©).\]
  Therefore,
  \[w |c·µ£‚ü© ‚àà L(‚ü®C_S^*‚ü©) ‚ãÖ L(|C_{S'}‚ü©).\]
  Finally, by unfolding the definition of \(L(‚ü®C_S^*‚ü©) ‚ãÖ L(|C_{S'}‚ü©)\),
  we obtain \(s' ‚àà S\).
\end{proof}

\begin{corollary}\label{the: reachability provability equivalence for terminating machine}
  For a machine \(M ‚âú (S, sÃÇ, Œπ)\) that always halt regardless of the input,
  it will have finitely many reachable states from any input.
  Therefore, for any input \((m, n)\), 
  \(S'\) contains all the reachable state from \((sÃÇ, m, n)\) if and only if
  \cref{ineq: reachability inequality} is provable.
\end{corollary}

We can then construct our diagonal argument.
Assume that the equational theory of KA with atomic commutativity is decidable,
there is a machine \(P(S', M, M')\) that decides whether 
\cref{ineq: reachability inequality} is provable when given machine \(M ‚âú (S, sÃÇ, Œπ)\) 
with the encoding of \(M'\) as input, and a subset of states \(S' ‚äÜ S\).

Fix two distinct states \(s‚ÇÅ, s‚ÇÇ\),
we define the diagonal machine \(D(M)\) as follows: 
let \(M ‚âú (S, sÃÇ, Œπ)\) and \(S' ‚âú S ‚àñ \{s‚ÇÅ\}\),
\begin{itemize}
  \item if \(P(S', M, M)\) returns true, 
    then we will go to state \(s‚ÇÅ\) and returns true;  
  \item if \(P(S', M, M)\) returns false,
    then we will go to state \(s‚ÇÇ\) and returns false.
\end{itemize}
Hence, state \(s‚ÇÅ\) is reachable if and only if \(P(S', M, M)\) returns true. 

Then we employ the standard technique to feed the diagonal machine to itself.
since we assumed equalities in KA with atomic commutativity is decidable, 
therefore \(D\) always terminates; hence we can enumerate all the possible 
the output of \(D(D)\):
\begin{itemize}
  \item If \(D(D)\) returns true, then \(P(S', D, D)\) returns true. 
    By \Cref{the: reachability provability equivalence for terminating machine},
    \(S' ‚âú S ‚àñ \{s‚ÇÅ\}\) contains all the reachable states of \(D(D)\).
    However, by definition of \(D\), \(s‚ÇÅ\) is reachable when \(P(S', D, D)\) is true,
    and \(s‚ÇÅ ‚àâ S'\). Therefore, we obtain a contradiction.
  \item  If \(D(D)\) returns false, this means that \(P(S', D, D)\) is false. 
    By \Cref{the: reachability provability equivalence for terminating machine},
    \(S' ‚âú S ‚àñ \{s‚ÇÅ\}\) do not contain all the reachable state.
    However, by definition of \(D\), \(s‚ÇÅ\) is not reachable in this case,
    and \(S'\) contains every state other than \(s‚ÇÅ\).
    Hence, \(S'\) has to contain all the reachable state of \(D(D)\).
    We got a contradiction again.
\end{itemize}
Therefore, our assumption that KA with atomic commutativity is decidable has to be false.

\begin{corollary}[Incompleteness]
  There exists some commutable set \(X\) and two expression \(e‚ÇÅ, e‚ÇÇ ‚àà \KA(X)\) 
  s.t. \(L(e‚ÇÅ) ‚äÜ L(e‚ÇÇ)\) but \(e‚ÇÅ ‚â∞ e‚ÇÇ\).
  In other words, there exists inequalities in the language interpretation
  that is not derivable using the theory.
\end{corollary}

\begin{proof}
  Assume that the language interpretation is complete,
  that is for all expression \(e‚ÇÅ, e‚ÇÇ\)
  \[L(e‚ÇÅ) ‚äÜ L(e‚ÇÇ) ‚ü∫ e‚ÇÅ ‚â§ e‚ÇÇ.\]

  By definition of \(\KA(X)\), 
  \(e‚ÇÅ = e‚ÇÇ\) if and only if it can be proven using the theory of KA 
  plus the commutativity in \(X\),
  therefore deciding general equality is recursively-enumerable, by enumerating the proof.

  However, since word inhabitance is decidable,
  language inclusion is co-recursively-enumerable,
  since we can simply check whether all words in \(L(e‚ÇÅ)\) is in \(L(e‚ÇÇ)\).

  If the language inclusion is equivalent to inequalities in the theory,
  then the problem of inequalities in the theory is both recursively-enumerable
  and co-recursively-enumerable, hence decidable.
  This result contradicts our undecidability result for general inequality in 
  KA with atomic commutativity hypotheses.
  Therefore, our assumption is false, and language interpretation is incomplete.
\end{proof} 

\section{Conclusion And Open Problem}

In this paper we have shown that the word inhabitance problem 
in KA with commutativity hypotheses is decidable and complete,
yet the general equalities are neither decidable nor complete.
We believe this is the first known KA extension 
where the word inhabitance problem is decidable,
yet the general equality is not.

Our method to show the decidability of word inhabitance problem
involves using the matrix model to decompose a word into several components,
which we believe is a novel technique in defining 
the empty word predicate and derivative in extensions of Kleene Algebra.
This technique also yields straight-forward proof of soundness and the fundamental theorem.

However, there are still several important open problems:
Several theorems leading to the undecidability result requires 
introspection on each case of the instructions, 
which leads to very long and tedious proof.
We suspect some of these proofs, like the proof for \Cref{the: single step transition soundness}, 
can be simplified by establishing more 
connection between the language interpretation and the free models.
The exact complexity of KA with atomic commutativity is still unknown.
In particular, we do not know whether the problem of 
deciding general equalities are RE-complete.


\bibliographystyle{ACM-Reference-Format}
\bibliography{refs}

