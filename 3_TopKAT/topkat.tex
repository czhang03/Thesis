\chapter{Domain Reasoning In TopKAT}
\label{chapter:TopKAT}
\thispagestyle{myheadings}

% set this to the location of the figures for this chapter. it may
% also want to be ../Figures/2_Body/ or something. make sure that
% it has a trailing directory separator (i.e., '/')!
\graphicspath{{3_Details/Figures/}}



\section{Completeness and Decidability of TopKAT}
\label{sec: general completeness}

Our goal in this section is to construct a complete interpretation for TopKAT,
thereby reducing its theory that of plain KAT.  In other words, any equation
between two TopKAT terms is logically equivalent to another equation between a
pair of corresponding KAT terms.  While this result is not
new~\cite{Zhang_de_Amorim_Gaboardi_2022, Zhang_de_Amorim_Gaboardi_2022_POPL,
  Pous_Wagemaker_2022}, we present a more streamlined proof that hinges on the
universal properties of free KATs and TopKATs, without relying explicitly on
language models.  In any case, as a consequence of this result, we obtain the
decidability of the equational theory of TopKAT as a corollary.  Moreover, our
technique helps us to construct complete models and interpretations simply by
computation, as well as simplifying proofs of other results about TopKAT.

% AAA: It would be nice if we could mention explicitly how this helps the next
% section.

\subsection{Reduction on free models}\label{sec: reduction on free models}

We first note that any free KAT over an alphabet \(K, B\) is also a TopKAT,
where the largest element is \((âˆ‘ K)^*\). This fact can be seen by
straightforward induction.
\begin{lemma}\label{the: every free KAT is a TopKAT}
    Every free KAT over alphabet \(K, B\) form a TopKAT.
\end{lemma}

\begin{proof}
    Since free KAT is a KAT, all we need to show is that a top element exists in any free KAT:
    the top element of a free KAT over \(K, B\) is \((âˆ‘ K)^*\).
    This fact straightforward to show,
    all we need to show is that it is larger than every term in the free model,
    some manipulation standard theorems in KA.
    \begin{itemize}
        \item Since \((âˆ‘ K)^* â‰¥ 1\) (by unfolding rule),
              then it is larger than \(0, 1\) and any boolean terms.
        \item Since \((âˆ‘ K)^*\) is larger than \(âˆ‘ K\),
              which is larger than any primitive action.
        \item Given any two term \(tâ‚\) and \(tâ‚‚\),
              if \((âˆ‘ K)^*\) is larger than both,
              then it is larger than \(tâ‚ + tâ‚‚\):
              because \(tâ‚ + tâ‚‚\) is the \(\sup\) of \(tâ‚\) and \(tâ‚‚\).
        \item Given any two term \(tâ‚\) and \(tâ‚‚\),
              if \((âˆ‘ K)^*\) is larger than both,
              then it is larger than \(tâ‚ â‹… tâ‚‚\):
              since \((âˆ‘ K)^* = (âˆ‘ K)^* â‹… (âˆ‘ K)^*\)
              and multiplication preserves order, therefore:
              \[(âˆ‘ K)^* = (âˆ‘ K)^* â‹… (âˆ‘ K)^* â‰¥ tâ‚ â‹… tâ‚‚.\]
        \item Given a term \(t\),
              if \((âˆ‘ K)^* â‰¥ t\), then \((âˆ‘ K)^* â‰¥ t^*\).
              Since \((âˆ‘ K)^* = ((âˆ‘ K)^*)^*\) and star preserves order:
              \[(âˆ‘ K)^* = ((âˆ‘ K)^*)^* â‰¥ t^*\]
    \end{itemize}
\end{proof}

Since every free KAT is a TopKAT, every KAT interpretation
\(I : \KAT â†’ \mathcal{M}\) induces a sub-KAT $\Img(I) âŠ† \mathcal{M}$,
and this sub-KAT happens to be a \emph{TopKAT}. Indeed, the image of $(âˆ‘ K)^*$
in $\mathcal{M}$ is the largest element of $\Img(I)$, and the restriction
$I : \KAT â†’ \Img(I)$ is a homomorphism of TopKATs.

This gives us a powerful tool to construct complete TopKAT interpretations.
Since we already know that the KAT interpretations \(G: \KAT â†’ ğ’¢\) and
\(h âˆ˜ G: \KAT â†’ \Img(h)\) are TopKAT homomorphisms and are injective, we can
construct complete TopKAT interpretations by \emph{composition}, simply by
constructing an injective TopKAT interpretation \(r\) of type
\(\TopKAT(K, B) â†’ \KAT(K_âŠ¤, B)\):
\begin{align*}
    & \TopKAT(K, B) \xrightarrow{r} \KAT(K_âŠ¤, B) \xrightarrow{G} ğ’¢_{K_âŠ¤, B},\\  
    & \TopKAT(K, B) \xrightarrow{r} \KAT(K_âŠ¤, B) \xrightarrow{G} ğ’¢_{K_âŠ¤, B}
    \xrightarrow{h} \Img(h).
\end{align*} 
Since an interpretation is determined by its action
on primitives, we can define \(r\) just by specifying its behavior on \(K + B\):
\begin{align*}
    r   & : K + B â†’ \KAT(K_âŠ¤, B)             \\
    r(p) & â‰œ p                     & p âˆˆ K + B.
\end{align*}
Since this is the only such $r$ with this property, we can check that the
homomorphism $r$ coincides with the \emph{reduction maps} of the same name in
previous works~\cite{Zhang_de_Amorim_Gaboardi_2022, Pous_Wagemaker_2022}.  More
concretely, we can picture $r$ as simply replacing the symbol \(âŠ¤\) in a TopKAT
term with \((âˆ‘ K_âŠ¤)^*\), the largest element in \(\KAT(K_âŠ¤, B)\).

We will show that \(r\) is injective by constructing a left inverse for it.  In
fact, the left inverse is a very principled map.
\begin{lemma}
  The natural map \([-]_âŠ¤: \KAT(K_âŠ¤, B) â†’ \TopKAT(K, B)\), where each term is
  mapped to its corresponding equivalence class, is a TopKAT homomorphism.
\end{lemma}

% AAA: I think it would be more elegant to define this map using the universal
% property of \KAT :) -- that is, by mapping âŠ¤ to âŠ¤.

\begin{proof}
  First, note that this map is well-defined.  Indeed, a raw KAT term over
  $K_âŠ¤, B$ can be viewed as a raw TopKAT term over $K, B$.  Moreover, since the
  theory of TopKAT extends that of KAT with an equation, any two equivalent KAT
  terms are also equivalent when seen as KAT terms. Thus, the identity on raw
  terms can be lifted to equivalence classes.


  Since each term in \(\KAT(K_âŠ¤, B)\) is mapped to its identical term in
  \(\TopKAT(K, B)\), then it is clear that is preserves all the operations
  except perhaps for \(âŠ¤\).

  All we need to show is that \([-]_âŠ¤\) preserves the top element, that is
  \([(âˆ‘ K_âŠ¤)^*]_âŠ¤\) is the largest element in \(\TopKAT(K, B)\), which suffices
  to prove \((âˆ‘ K_âŠ¤)^* â‰¥ âŠ¤\).
    \[(âˆ‘ K_âŠ¤)^* â‰¥ âˆ‘ K_âŠ¤ = âŠ¤ + âˆ‘ K â‰¥ âŠ¤.\]
\end{proof}

\begin{lemma}[reduction]
    \([-]_âŠ¤\) is the right inverse of \(r\): \([-]_âŠ¤ âˆ˜ r  = id_{\TopKAT(K, B)}\).
    More explicitly for all \(t âˆˆ \TopKAT(K, B)\): \[\TopKAT(K, B) âŠ§ [r(t)]_âŠ¤ = t.\]
\end{lemma}

\begin{proof}
    Since \([-]_âŠ¤ âˆ˜ r : \TopKAT(K, B) â†’ \TopKAT(K, B)\) is a TopKAT interpretation,
    hence the action on the primitive uniquely determines the interpretation:
    because both \(r\) and \([-]_âŠ¤\) do not change the primitives,
    therefore \([-]_âŠ¤ âˆ˜ r\) is the identity interpretation on \(\TopKAT(K, B)\).
\end{proof}

The above lemma matches one of the soundness condition of reductions in 
previous works~\cite{Zhang_de_Amorim_Gaboardi_2022,Kozen_Smith_1997,Pous_Rot_Wagemaker_2021},
which was typically proven by induction on the structure of terms.
The induction approach involves case analysis on all operations of TopKAT~\cite{Zhang_de_Amorim_Gaboardi_2022};
whereas our approach determines the equality simply 
by computing the action of \([-]_âŠ¤ âˆ˜ r\) on primitives.

Since \(r\) has a right inverse, it is a complete TopKAT interpretation:
\[\TopKAT(K, B) âŠ§ tâ‚ = tâ‚‚ âŸº r(tâ‚) = r(tâ‚‚),\]
With the completeness of \(r\), we can already show the complexity of TopKAT.

\begin{corollary}[Complexity]\label{the: PSPACE-completeness of TopKAT}
  Given two terms \(tâ‚, tâ‚‚ âˆˆ \TopKAT(K, B)\), deciding whether these two terms
  are equal is PSPACE-complete.
\end{corollary}

\begin{proof}
    Since deciding KAT equality is a sub-problem of deciding TopKAT equality,
    and KAT equality is PSPACE-hard \cite{Cohen_Kozen_Smith_1999},
    Thus TopKAT equality is PSPACE-hard.

    To decide the equality of \(tâ‚, tâ‚‚\),
    we first remove all the redundant primitive that does not appear in \(tâ‚, tâ‚‚\)
    from the alphabet \(K, B\). Then we compute \(r(tâ‚)\) and \(r(tâ‚‚)\),
    each taking polynomial space (of \(|tâ‚| + |tâ‚‚|\)) to store;
    and we use the standard algorithm \cite{Cohen_Kozen_Smith_1999}
    to decide whether \(r(tâ‚) = r(tâ‚‚)\) in \(\KAT(K_âŠ¤, B)\),
    this will also take polynomial space.
    Hence, the decision procedure for TopKAT equality in PSPACE.

    Thus deciding TopKAT equality is PSPACE-complete.
\end{proof}


\subsection{Complete Model For Free}\label{sec: complete model for free}

Designing complete interpretations and models was not always easy.
In fact, in previous works \cite{Zhang_de_Amorim_Gaboardi_2022_POPL},
the authors made a mistake in the definition of language TopKAT,
which was fixed later \cite{Zhang_de_Amorim_Gaboardi_2022} 
by suggestion of Pous et al. \cite{Pous_Wagemaker_2022}.
However, with the results in~\Cref{sec: reduction on free models},
we can construct the complete interpretation just by composition,
and compute the complete model by computing the range of the complete interpretation.

We already know that there are two complete interpretations of TopKAT defined as follows:
\begin{align*}
    & \TopKAT(K, B) \xrightarrow{r} \KAT(K_âŠ¤, B) \xrightarrow{G} ğ’¢_{K_âŠ¤, B},\\  
    & \TopKAT(K, B) \xrightarrow{r} \KAT(K_âŠ¤, B) \xrightarrow{G} ğ’¢_{K_âŠ¤, B} \xrightarrow{h} \Img(h),
\end{align*}
with a complete language model \(ğ’¢_{K_âŠ¤, B}\), 
and a complete model consists of relations \(\Img(h)\).

The operations in these models can be recovered by computing these maps.
For example, the multiplication operation in the language TopKAT can be computed as follows:
\[G âˆ˜ r(tâ‚ â‹… tâ‚‚) = G(r(tâ‚) â‹… r(tâ‚‚)) = G(r(tâ‚)) â‹„ G(r(tâ‚‚)).\]
Since \(r\) do not change the multiplication operation,
the multiplication in the language TopKAT is the same as in language KAT.
In fact, as \(r\) do not change any operation in KAT,
most operations in language TopKAT is the same as language KAT.
Thus, we only need to figure out the top element in language TopKAT.

The top element in language TopKAT can be computed in the same fashion:
\[G âˆ˜ r(âŠ¤) = G((âˆ‘ K_âŠ¤)^*) = GS_{K_âŠ¤, B},\]
i.e. the top element is just the complete language.

\begin{corollary}\label{the: language TopKAT for free}
    The language TopKAT inherits all the operations in language KAT,
    except the top element is defined as the full language.
    And such model is complete with \(G âˆ˜ r\) as a complete interpretation.
\end{corollary}

In the same way, we know that complete model consisting of relations (a.k.a. general relational TopKAT) 
will have the same operations as relational KATs.
However, in this case the characterization the computed top: \(h âˆ˜ G âˆ˜ r(âŠ¤)\)
is not as simple as the full language;
but we know it is the largest relation in the range of \(h âˆ˜ G âˆ˜ r\):

\begin{corollary}\label{the: general relational TopKAT for free}
    The general relational TopKAT inherits all the operations in relational KAT,
    except the top element is the largest relation.
    And such model is complete with \(h âˆ˜ G âˆ˜ r\) as a complete interpretation.
\end{corollary}

Finally, to investigate whether we can use general relational TopKAT
to encode incorrectness logic,
we will provide a short proof that general relational TopKATs
are as expressive as relational KATs~\cite{Zhang_de_Amorim_Gaboardi_2022};
that is, every property on relations that can be encoded using general relational TopKAT,
is already encodable in the relational  KAT.
Hence, adding a top element do not give extra expressive power in general relational TopKAT.

% AAA: We should recall what "expressible" means here, to make the paper
% self-contained.

The original proof~\cite[Lemma 2]{Zhang_de_Amorim_Gaboardi_2022} 
encodes every TopKAT term using KAT term,
and then use two pages to prove the soundness of such encoding.
Here we show such encoding is simply the reduction \(r\).
\begin{corollary}[Expressiveness of general relational TopKAT]
    Given an alphabet \(K, B\), an n-ary predicate \(P\) on relations,
    the predicate \(P\) over primitives \(pâ‚, pâ‚‚, â€¦ , pâ‚™ âˆˆ K\) is expressible in
    general relational TopKAT if and only if it is expressible in relational KAT.

    Formally, it suffices to show that if there exist two terms
    \(tâ‚, tâ‚‚ âˆˆ \TopKAT(K, B)\) s.t. for any general relational interpretation
    \(I_âŠ¤\):
    \[I_âŠ¤(tâ‚) = I_âŠ¤(tâ‚‚) âŸº P(I_âŠ¤(pâ‚), I_âŠ¤(pâ‚‚), â€¦ , I_âŠ¤(pâ‚™));\]
    then take an arbitrary relational KAT interpretation \(I\):
    \[I(r(tâ‚)) = I(r(tâ‚‚)) âŸº P(I(pâ‚), I(pâ‚‚), â€¦ , I(pâ‚™)).\]
\end{corollary}

\begin{proof}
    Take an arbitrary relational KAT interpretation \(I\) from \(\KAT(K_âŠ¤, B)\).
    Notice \(\Img(I)\), the range of \(I\), is a relational KAT with a largest element
    (\(I\) of the largest element in \(\KAT(K_âŠ¤, B)\));
    hence \(\Img(I)\) is a general relational TopKAT.
    Then \(I\) is a TopKAT homomorphism from \(\KAT(K_âŠ¤, B)\) to its range:
    \(I\) preserves all the operation of KAT, since it is a KAT interpretation;
    and preserves the top element, since homomorphism preserves order.

    Then we can construct \(I âˆ˜ r: \TopKAT(K, B) â†’ \Img(I)\),
    a general relational interpretation.
    And since \(r\) does not modify primitives,
    therefore \[âˆ€ páµ¢ âˆˆ K, I âˆ˜ r(páµ¢) = I(r(páµ¢)) = I(páµ¢).\]

    Finally,
    \begin{align*}
        & I(r(tâ‚)) = I(r(tâ‚‚)) \\
         & âŸº I âˆ˜ r(tâ‚) = I âˆ˜ r(tâ‚‚)                           \\
         & âŸº P(I âˆ˜ r(pâ‚), â€¦ , I âˆ˜ r(pâ‚™))
         & \text{\(I âˆ˜ r\) is a \(\TopGREL\) interpretation} \\
         & âŸº P(I(pâ‚), â€¦ , I(pâ‚™))
         & âˆ€ páµ¢ âˆˆ K, I âˆ˜ r(páµ¢) = I(páµ¢)
    \end{align*}
\end{proof}

Since the image of \(I\) is not necessary a relational TopKAT,
where the top element is interpreted as the complete relation,
The above trick do not work for relational TopKAT.
It is also known that relational TopKAT is strictly more expressive than general relational TopKAT,
since relational TopKAT can encode incorrectness logic,
where general relational TopKAT cannot~\cite{Zhang_de_Amorim_Gaboardi_2022}.


\section{Domain Completeness}\label{sec: domain completeness of TopKAT}

In general, TopKAT is not complete over relational models, which are crucial for
program-analysis applications~\cite{Zhang_de_Amorim_Gaboardi_2022}.  However, it
was later showed that we \emph{can} obtain a complete theory for relational
models by simply adding the axiom \(p âŠ¤ p â‰¥ p\) to the theory of
TopKAT~\cite{Pous_Wagemaker_2022}.  We aim to investigate how much these two
theories differ in expressive power for program reasoning.  In particular, the
encoding of incorrectness logic in TopKAT~\cite{Zhang_de_Amorim_Gaboardi_2022}
relies only on the ability of TopKAT to compare the domain and codomain of two
relations.  This raises the question of whether TopKAT suffices for proving such
properties; that is, whether the following completeness results hold: for
\(tâ‚, tâ‚‚ âˆˆ \KAT(K, B)\) (i.e. \(âŠ¤\) does not appear in \(tâ‚\) and \(tâ‚‚\))
\begin{align*}
    \REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚) & âŸº \TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚ & \text{codomain completeness} \\
    \REL âŠ§ \dom(tâ‚) â‰¥ \dom(tâ‚‚) & âŸº \TopKAT âŠ§ tâ‚ âŠ¤ â‰¥ tâ‚‚ âŠ¤ & \text{domain complete}
\end{align*}

In this section, we prove that these equivalences hold, even without the
additional axiom \(p âŠ¤ p â‰¥ p\).
%
However, they do \emph{not} hold if we allow terms that contain top: for
example, let \(tâ‚ â‰œ p âŠ¤ p\), and \(tâ‚‚ â‰œ p\).  Since \(p âŠ¤ p â‰¥ p\) holds in
relational TopKAT, thus \(\dom(p âŠ¤ p) â‰¥ \dom(p)\); but \(p âŠ¤ p âŠ¤ â‰¥ p âŠ¤\) is not
provable in TopKAT, since the inequality is not true in the language
interpretation: \(G âˆ˜ r(p âŠ¤ p âŠ¤)\) gives the language which contains at least
two \(p\) and starts with action \(p\), which does not contain \(G âˆ˜ r(p âŠ¤)\),
where only starting with action \(p\) is required.  The incompleteness of
codomain comparison can also be shown using the same example.

The core idea to prove codomain completeness for KAT terms 
is to construct a specific relational interpretation,
where its codomain is equivalent to the complete TopKAT interpretation \(G âˆ˜ r\):
\[\cod(h âˆ˜ i âˆ˜ G(t)) = G âˆ˜ r(âŠ¤ t),\] 
where \(i\) is the natural inclusion homomorphism \(i: ğ’¢_{K, B} â†ª ğ’¢_{K_âŠ¤, B}\), 
that maps every language to itself;
and \(h\) is the classical embedding of language KAT into relational KAT~\cite{Kozen_Smith_1997}.
Although \(i\) will not change the outcome of \(G\),
it will add a new primitive action \(âŠ¤\) to the alphabet, hence changing the outcome of \(h\).
Such addition will equate the codomain of \(h âˆ˜ i âˆ˜ G(t)\) 
with the complete TopKAT interpretation \(G âˆ˜ r\) of \(âŠ¤ t\).
The proof of this equality is by simply computing both sides of the equation.
\begin{lemma}\label{the: codomain completeness core lemma}
    For any term \(t âˆˆ \KAT_{K, B}\),
    \[\cod(h âˆ˜ i âˆ˜ G(t)) = G âˆ˜ r(âŠ¤ t),\]
    where \(i\) is the nature inclusion homomorphism \(i: ğ’¢_{K, B} â†ª ğ’¢_{K_âŠ¤, B}\);
    and \(h\) is the classical homomorphism used by Pratt's trick
    to embed language KAT into relational KAT~\cite{Kozen_1997,Pratt_1980}:
    \begin{align*}
        h & : ğ’¢ â†’ ğ’«(ğ’¢ Ã— ğ’¢)                                      \\
        h & (S) â‰œ \{(s Î±, s Î± sâ‚) âˆ£ s Î± âˆˆ GS, Î± sâ‚ âˆˆ S\},
    \end{align*}
\end{lemma}

\begin{proof}
    We explicitly write out the domain and codomain of the functions in
    the relational KAT interpretation \(h âˆ˜ i âˆ˜ G\) for the ease of the reader:
    \[\KAT_{K, B}
        \xrightarrow{G} ğ’¢_{K, B}
        \xrightarrow{i} ğ’¢_{K_âŠ¤, B}
        \xrightarrow{h} ğ’«(ğ’¢_{K_âŠ¤, B} Ã— ğ’¢_{K_âŠ¤, B})\]

    Although \(i\) do not change its input,
    the addition of \(âŠ¤\) into the alphabet will change the result of \(h\).
    In this case, \(h\) is a KAT homomorphism from \(ğ’¢_{K_âŠ¤, B}\):
    \[h(S) = \{(s, s â‹„ sâ‚) âˆ£ s âˆˆ GS_{K_âŠ¤, B}, sâ‚ âˆˆ S\}.\]
    Since the reduction \(r\) preserves terms without \(âŠ¤\),
    let \(t âˆˆ \KAT_{K, B}\) (i.e. \(t\) does not contain \(âŠ¤\)):
    \[G âˆ˜ r(âŠ¤) = GS_{K_âŠ¤, B} \\ G âˆ˜ r(t) = G(t).\]
    Therefore, for any term \(t âˆˆ \KAT_{K, B}\)
    \begin{align*}
        \cod(h âˆ˜ i âˆ˜ G(t))
         & = \{s Î± sâ‚ âˆ£ s Î± âˆˆ GS_{K_âŠ¤, B}, Î± sâ‚ âˆˆ G(t)\} \\
         & = GS_{K_âŠ¤, B} â‹„ G(t)                          \\
         & = (G âˆ˜ r(âŠ¤)) â‹„ (G âˆ˜ r(t))                     \\
         & = G âˆ˜ r(âŠ¤ t).
    \end{align*}
\end{proof}

With the above equality obtained, the codomain completeness can be shown as follows.
\begin{theorem}[Codomain completeness]\label{the: codomain completeness}
    Given two terms \(tâ‚, tâ‚‚ âˆˆ \KAT(K, B)\) (i.e. term without \(âŠ¤\)),
    then codomain comparison is complete:
    \begin{align*}
        \REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚) & âŸº \TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚.
    \end{align*}
\end{theorem}

\begin{proof}
    Given the natural inclusion homomorphism: \(i: \KAT(K, B) â†’ \KAT(K_âŠ¤, B)\),
    we show that the following are equivalent:
    \begin{enumerate}
        \item \(\REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚).\)
        \item \(\cod(h âˆ˜ i âˆ˜ G(tâ‚)) â‰¥ \cod(h âˆ˜ i âˆ˜ G(tâ‚‚)).\)
        \item \(\TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚.\)
    \end{enumerate}

    We first show that \(1 âŸ¹ 2\), since \(\REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚)\),
    means \(\cod(I(tâ‚)) â‰¥ \cod(I(tâ‚‚))\) for all relational KAT interpretation \(I\),
    and \(h âˆ˜ i âˆ˜ G\) is a relational KAT interpretation, so this is true.

    We show \(2 âŸ¹ 3\), which uses the equality discussed above, 
    and proved in~\Cref{the: codomain completeness core lemma}:
    \begin{align*}
             & \cod(h âˆ˜ i âˆ˜ G(tâ‚)) â‰¥ \cod(h âˆ˜ i âˆ˜ G(tâ‚‚))           \\
        âŸº {} & G âˆ˜ r(âŠ¤ tâ‚) â‰¥ G âˆ˜ r(âŠ¤ tâ‚‚)
             & \text{\Cref{the: codomain completeness core lemma}} \\
        âŸº {} & \TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚.
             & \text{Completeness of \(G âˆ˜ r\)}
    \end{align*}

    Finally, we show \(3 âŸ¹ 1\),
    since \(\TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚ âŸ¹ \TopREL âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚,\)
    and because \(\TopREL âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚ âŸ¹ \REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚)\) 
    (\Cref{the: top element represent domain}), 
    therefore \(\TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚ âŸ¹ \REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚)\).
\end{proof}


The domain completeness can be obtained from
exploring the properties of relational converse.
Recall the definition of converse operator on relation \(R^{âˆ¨} â‰œ \{(b, a) âˆ£ (a, b) âˆˆ R\}\),
Then by unfolding the definition, we have \(\cod(R) = \dom(R^{âˆ¨}).\)

We can extend this converse operations to relational KAT interpretation.
Given a interpretation \(I: \KAT(K, B) â†’ X Ã— X\), 
we can define \(I^{âˆ¨}\) by conversing the action of \(I\) on primitives: 
\begin{align*}
    I^{âˆ¨} & : K + B â†’ X Ã— X \\
    I^{âˆ¨} & (p) â‰œ I(p)^{âˆ¨}.
\end{align*}
The converse operator \((-)^{âˆ¨}: (\KAT(K, B) â†’ X Ã— X) â†’ (\KAT(K, B) â†’ X Ã— X)\) 
is an isomorphism on relational interpretation, where it is own inverse.
This can be verified by looking at the action of \((-)^{âˆ¨} âˆ˜ (-)^{âˆ¨}(I)\)
on the primitives:
\[âˆ€ p âˆˆ K + B, (I^{âˆ¨})^{âˆ¨}(p) = ((I(p))^{âˆ¨})^{âˆ¨} = I(p) âŸ¹
(-)^{âˆ¨} âˆ˜ (-)^{âˆ¨} = id_{(\KAT(K, B) â†’ X Ã— X)}.\]
Therefore, for an arbitrary relational KAT interpretation \(I\),
we can find a relational KAT interpretation \(I'\) s.t. \(I'^{âˆ¨} = I\);  
then if \(\dom(I'^{âˆ¨}(tâ‚)) = \dom(I'^{âˆ¨}(tâ‚‚))\), 
we can derive \[\cod(I(tâ‚)) = \dom(I'^{âˆ¨}(tâ‚)) = \dom(I'^{âˆ¨}(tâ‚‚)) = \cod(I(tâ‚‚)).\]
Let \(I'\) and \(I\) ranges over all relational KAT interpretations,
by the previous result, we have
\[ âˆ€ I', \dom(I'(tâ‚)) = \dom(I'(tâ‚‚)) 
    âŸ¹ âˆ€ I, \cod(I(tâ‚)) = \cod(I(tâ‚‚))
    âŸ¹ tâ‚ âŠ¤ = tâ‚‚ âŠ¤. \]
Thus, we obtained the non-trivial side of domain completeness result,
and the other side is a direct consequence of~\cref{the: top element represent domain}.

\begin{theorem}[Domain Completeness]
    Given two terms \(tâ‚, tâ‚‚ âˆˆ \KAT(K, B)\) (i.e. term without \(âŠ¤\)),
    then domain comparison is complete:
    \begin{align*}
        \REL âŠ§ \cod(tâ‚) â‰¥ \cod(tâ‚‚) âŸº \TopKAT âŠ§ âŠ¤ tâ‚ â‰¥ âŠ¤ tâ‚‚.
    \end{align*}
\end{theorem}


\section{A Coalgebraic Theory of TopKAT}

Coalgebraic decision procedure has shown great promise in 
real-world applications~\cite{Foster_Kozen_Milano_Silva_Thompson_2015, Smolka_Kumar_Kahn_Foster_Hsu_Kozen_Silva_2019, Pous_2015}.
In this section we will develop the coalgebraic theory of TopKAT;
it should come as no surprise that such coalgebraic theory can be obtained trivially 
using the reduction result, and produce a efficient decision procedure. 
Further demonstrating the importance of such reduction result.

Later we will show that the coalgebraic decision procedure 
for determining reachability properties is as efficient as breath-first search.
This demonstrate that our procedure is general enough to cover all equation of TopKAT;
yet when specialized to domain comparison, it is as efficient as specialized algorithms.

\subsection{Kleene Coalgebra with Tests}

A Kleene Coalgebra with tests (KCT) \(ğ’¦\) over a alphabet \((K, B)\) 
consists of two family of operations indexed by \(Î± âˆˆ 1_{ğ’¢}\) and \(Î± p âˆˆ 1_{ğ’¢} Ã— K\):
\[Ïµ_{Î±}: ğ’¦ â†’ 2, \\ Î´_{Î± p}: ğ’¦ â†’ ğ’¦,\]
where \(2 â‰œ \{0, 1\}\) is the two-element set.
By the natural isomorphism \((ğ’¦ â†’ 2) Ã— (ğ’¦ â†’ ğ’¦) â‰… ğ’¦ â†’ 2 Ã— ğ’¦\),
these two operations can be combined into one, denoted as
\(âŸ¨Ïµ_Î±, Î´_{Î± p}âŸ©: ğ’¦ â†’ 2 Ã— ğ’¦.\)
These operations are inspired by the structure of guarded languages,
intuitively, \(Ïµ_Î±\) computes whether \(Î±\) is contained with in a guarded language,
and \(Î´_{Î± p}\) computes the remaining language after \(Î± p\) has been removed from the front.

This intuition can be made concrete by the finality of the guarded language model.
Guarded language model \(ğ’¢_{K, B}\) forms a KCT when equipped with the following operations:
\begin{align*}
    Ïµ_Î± & : ğ’¢ â†’ 2 &  Î´_{Î± p} & : ğ’¢ â†’ ğ’¢ \\  
    Ïµ_Î± & (S) â‰œ (Î± âˆˆ S),  & Î´_{Î± p} & (S) â‰œ \{s âˆ£ Î± p s âˆˆ S\}.
\end{align*}
Notice that these two operation exactly corresponds to our intuitions.
Furthermore, the guarded language over \(K, B\) is final in all KCT over \(K, B\):
for all KCT \(ğ’¦\), there exists a unique homomorphism \(h: ğ’¦ â†’ ğ’¢\):
\[
    \begin{tikzcd}
        ğ’¦ \ar[dashed]{r}{h} \ar{d}[swap]{âŸ¨Ïµ_Î±, Î´_{Î± p}âŸ©} & ğ’¢ \ar{d}{âŸ¨Ïµ_Î±, Î´_{Î± p}âŸ©} \\
        2 Ã— ğ’¦ \ar[swap, dashed]{r}{(id, h)} & 2 Ã— ğ’¢ 
    \end{tikzcd}  
\]
This suggests that for all KCT \(ğ’¦\), we can correspond each of its element to a language,
and the commutativity of the diagram implies that the \(Ïµ_Î±, Î´_{Î± p}\) in \(ğ’¦\) 
will perform exactly the operation \(Ïµ_Î±, Î´_{Î± p}\) on their corresponding languages.

In particular, the free \(\KAT(K, B)\) with the operations \(E_{Î±}\) and \(D_{Î± p}\) 
defined by Kozen~\cite[Section 4.2]{Kozen_2008} from a KCT, 
and the unique coalgebra homomorphism from the \(\KAT(K, B)\) to \(ğ’¢_{K, B}\) 
is exactly the language interpretation:
\begin{equation}\label{the: the final interpretation from free KAT is language interpretation}
    \begin{tikzcd}
        \KAT(K, B) \ar[dashed]{r}{G} \ar{d}[swap]{âŸ¨E_Î±, D_{Î± p}âŸ©} & ğ’¢_{K, B} \ar{d}{âŸ¨Ïµ_Î±, Î´_{Î± p}âŸ©} \\
        2 Ã— \KAT(K, B) \ar[swap, dashed]{r}{(id, G)} & 2 Ã— ğ’¢_{K, B} 
    \end{tikzcd}  
\end{equation}
By finality of the language interpretation, two KAT terms are bisimilar if and only if 
they have the same guarded language interpretations~\cite[Theorem 2.2.6, Theorem 2.2.7]{Silva_2010}. 
And by completeness of the guarded language model~\cite{Kozen_Smith_1997},
two KAT terms are bisimilar if and only if they are equal in the free KAT.
Finally, Kozen showed that bisimulation on the coalgebra \(\KAT(K, B)\)
gives a PSPACE algorithm for deciding KAT equalities~\cite[Section 6]{Kozen_2008}.

\subsection{Coalgebra From Reduction}

Similar to the case of KCT, our definition of TopKAT coalgebra is based on 
the structure of guarded language model for TopKATs.
Although the guarded language model for TopKATs are also sets of guarded strings,
the \(âŠ¤\) symbol is always in the action alphabet, 
which differentiates the structure of guarded languages for KATs and TopKATs.
To handle the \(âŠ¤\) symbol,
we need an additional family of operations \(Î´_{Î± âŠ¤}: ğ’¦ â†’ ğ’¦\) to consume the \(âŠ¤\) symbol.
\begin{definition}[TopKAT coalgebra]
    A TopKAT coalgebra \(ğ’¦\) over \(K, B\) consists of three family of operations,
    indexed by \(Î± âˆˆ 1_ğ’¢\), \(Î± p âˆˆ 1_ğ’¢ Ã— K\) and \(Î± âˆˆ 1_ğ’¢\) respectively:
    \[Ïµ_Î±: ğ’¦ â†’ 2, \\  Î´_{Î± p}: ğ’¦ â†’ ğ’¦, \\  Î´_{Î± âŠ¤}: ğ’¦ â†’ ğ’¦.\]
    Where \(Î´_{Î± âŠ¤}\) is an operation that consumes an atom \(Î±\) and a \(âŠ¤\) symbol.
\end{definition}

Despite the slight differences in the definition,
TopKAT coalgebras have strong connections to Kleene coalgebras with tests:
\begin{corollary}
    Because of the natural isomorphism
    \((1_ğ’¢ Ã— K â†’ X) Ã— (1_ğ’¢ â†’ X) â‰… 1_ğ’¢ Ã— (K + 1) â†’ X â‰… 1_ğ’¢ Ã— K_âŠ¤ â†’ X\),
    three families of operations in TopKAT coalgebra can be combined into two families indexed by 
    \(Î± âˆˆ 1_ğ’¢\) and \(Î± p' âˆˆ 1_ğ’¢ Ã— (K_âŠ¤)\):
    \[Ïµ_Î±: ğ’¦ â†’ 2, \\  Î´_{Î± p'}: ğ’¦ â†’ ğ’¦.\]
    Therefore TopKAT coalgebras over \(K, B\) are exactly the KCTs over \(K_âŠ¤, B\).

    Since \(ğ’¢_{K_âŠ¤, B}\) is the final KCT over \(K_âŠ¤, B\), 
    it is the final TopKAT coalgebra over \(K, B\).
\end{corollary}

The two families coalgebra operations on the free TopKAT is defined as follow,
where the first operation is indexed by \(Î± âˆˆ 1_ğ’¢\) and the second by \(Î± p âˆˆ 1_ğ’¢ Ã— K_âŠ¤\):
\begin{align*}
    E_Î± âˆ˜ r: & \TopKAT(K, B) \xrightarrow{r} \KAT(K_âŠ¤, B) \xrightarrow{E_{Î±}} 2, \\\relax
    [-]_âŠ¤ âˆ˜ D_{Î± p} âˆ˜ r : &
        \TopKAT(K, B) \xrightarrow{r} \KAT(K_âŠ¤, B) \xrightarrow{D_{Î± p}} 
        \KAT(K_âŠ¤, B) \xrightarrow{[-]_âŠ¤} \TopKAT(K, B).
\end{align*}
The connection to language interpretation of TopKAT is apparent:
\begin{theorem}
    The language interpretation of TopKAT is the unique 
    coalgebra homomorphism from \(\TopKAT(K, B)\) to \(ğ’¢_{K_âŠ¤, B}\):
    \[
    \begin{tikzcd}
        \TopKAT(K, B) \ar[dashed]{r}{G âˆ˜ r} \ar{d}[swap]{âŸ¨E_Î± âˆ˜ r, [-]_âŠ¤ âˆ˜ D_{Î± p} âˆ˜ râŸ©} 
            & ğ’¢_{K_âŠ¤, B} \ar{d}{âŸ¨Ïµ_Î±, Î´_{Î± p}âŸ©} \\
        2 Ã— \TopKAT(K, B) \ar[swap, dashed]{r}{(id, G âˆ˜ r)} & 2 Ã— ğ’¢_{K_âŠ¤, B} 
    \end{tikzcd}  
\]
\end{theorem}
\begin{proof}
    The uniqueness is trivial by the finality of \(ğ’¢_{K_âŠ¤, B}\).
    We only need to show commutativity of the diagram,
    i.e. \((id, G âˆ˜ r) âˆ˜ âŸ¨E_Î± âˆ˜ r, D_{Î± p} âˆ˜ râŸ© = âŸ¨Ïµ_Î±, Î´_{Î± p}âŸ© âˆ˜ G âˆ˜ r,\)
    which is equivalent to show 
    \[E_Î± âˆ˜ r = Ïµ_Î± âˆ˜ G âˆ˜ r \text{ and } G âˆ˜ r âˆ˜ [-]_âŠ¤ âˆ˜ D_{Î± p} âˆ˜ r = Î´_{Î± p} âˆ˜ G âˆ˜ r.\]
    
    First by \cref{the: the final interpretation from free KAT is language interpretation},
    \(E_Î± = Ïµ_Î± âˆ˜ G âŸ¹ E_Î± âˆ˜ r = Ïµ_Î± âˆ˜ G âˆ˜ r.\)

    Then because \(r âˆ˜ [-]_âŠ¤ = id_{\TopKAT(K, B)}\) and 
    \cref{the: the final interpretation from free KAT is language interpretation},
    \(G âˆ˜ r âˆ˜ [-]_âŠ¤ âˆ˜ D_{Î± p} âˆ˜ r = G âˆ˜ D_{Î± p} âˆ˜ r = Î´_{Î± p} âˆ˜ G âˆ˜ r.\)
\end{proof}

Similar to the case in KAT, by finality of the guarded language interpretation of TopKAT
two TopKAT terms are bisimilar if and only if they have 
the same guarded language interpretations~\cite[Theorem 2.2.6, Theorem 2.2.7]{Silva_2010}.
And by completeness of the guarded language model~\cite{Kozen_Smith_1997},
two KAT terms are bisimilar if and only if they are equal in the free KAT.

Finally, since every TopKAT coalgebra is over \(K, B\) is a KCT over \(K_âŠ¤, B\),
and because there is a PSPACE bisimulation algorithm for KCT~\cite[Section 6]{Kozen_2008},
TopKAT bisimulation can also be computed in PSPACE.

We summarize the above two results in the following theorem:
\begin{theorem}[Completeness and Decidability]
    Two TopKAT terms are equal if and only if they are bisimilar,
    and the bisimilarity of two TopKAT term can be decided in PSPACE.
\end{theorem}